<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MQ,RocketMq," />










<meta name="description" content="https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1RE411r75d MQ介绍消息队列是一种“先进先出”的数据结构。  应用场景主要包括以下3个方面  应用解耦 替代RPC，降低耦合  流量削峰 缓存请求，避免请求压垮服务器  数据分发   1.2 MQ的优点和缺点优点：解耦、削峰、数据分发。 缺点：  系统可用性降低 外部依赖越多，稳定性越差，一旦MQ宕机，就会对业务造成影响。">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMq学习笔记">
<meta property="og:url" content="http://yoursite.com/2020/06/01/RocketMq%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="宋二的小窝">
<meta property="og:description" content="https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1RE411r75d MQ介绍消息队列是一种“先进先出”的数据结构。  应用场景主要包括以下3个方面  应用解耦 替代RPC，降低耦合  流量削峰 缓存请求，避免请求压垮服务器  数据分发   1.2 MQ的优点和缺点优点：解耦、削峰、数据分发。 缺点：  系统可用性降低 外部依赖越多，稳定性越差，一旦MQ宕机，就会对业务造成影响。">
<meta property="og:image" content="https://pic.imgdb.cn/item/5ed46cb3c2a9a83be56c0d15.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5ed6606cc2a9a83be5e5e6c1.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5ed8f998c2a9a83be58351d9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5efde28e14195aa594a1ce17.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5eff3c6414195aa59424388d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00846714195aa594a01a01.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00853414195aa594a077df.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00872014195aa594a15f0f.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00883114195aa594a1e2af.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00885414195aa594a1f3f9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f00893914195aa594a27427.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f01d3af14195aa59457b14c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f03265414195aa5940d489b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f0b237314195aa59431dc47.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f0b23ba14195aa59431f4a4.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f0b23d114195aa59431fcbb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f0c69cd14195aa5948c60ab.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145ba414195aa594e34985.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145e6714195aa594e42def.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145e9514195aa594e43d50.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145eb714195aa594e44914.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145eda14195aa594e45312.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145cd614195aa594e3a838.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145cb614195aa594e39d7b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145d0b14195aa594e3b848.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145d5f14195aa594e3d3b8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145d4c14195aa594e3ce57.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145da214195aa594e3e91e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145df714195aa594e4085c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145e3214195aa594e419e7.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f10556f14195aa594b1f6fa.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f10575214195aa594b28e20.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f10578414195aa594b29cc1.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f1058a114195aa594b2eeb5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f10596f14195aa594b32a01.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145ef914195aa594e45c89.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f105b5a14195aa594b3bca4.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f105de114195aa594b477c7.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f105e2214195aa594b48cca.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f105e7d14195aa594b4aa8b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f105ec514195aa594b4bfa4.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145f0f14195aa594e461fe.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f10608f14195aa594b54889.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/5f145f2c14195aa594e4694c.jpg">
<meta property="article:published_time" content="2020-06-01T02:46:56.000Z">
<meta property="article:modified_time" content="2020-07-19T14:57:03.702Z">
<meta property="article:author" content="宋梓立 sorie">
<meta property="article:tag" content="MQ">
<meta property="article:tag" content="RocketMq">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/5ed46cb3c2a9a83be56c0d15.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/01/RocketMq学习笔记/"/>





  <title>RocketMq学习笔记 | 宋二的小窝</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/Ewasong" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">宋二的小窝</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/01/RocketMq%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宋梓立 sorie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="宋二的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RocketMq学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-01T10:46:56+08:00">
                2020-06-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/01/RocketMq%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/06/01/RocketMq%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://www.bilibili.com/video/BV1RE411r75d" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1RE411r75d</a></p>
<h1 id="MQ介绍"><a href="#MQ介绍" class="headerlink" title="MQ介绍"></a>MQ介绍</h1><p>消息队列是一种“先进先出”的数据结构。</p>
<p><img src="https://pic.imgdb.cn/item/5ed46cb3c2a9a83be56c0d15.jpg" alt=""></p>
<p>应用场景主要包括以下3个方面</p>
<ul>
<li><p>应用解耦</p>
<p>替代RPC，降低耦合</p>
</li>
<li><p>流量削峰</p>
<p>缓存请求，避免请求压垮服务器</p>
</li>
<li><p>数据分发</p>
</li>
</ul>
<h2 id="1-2-MQ的优点和缺点"><a href="#1-2-MQ的优点和缺点" class="headerlink" title="1.2 MQ的优点和缺点"></a>1.2 MQ的优点和缺点</h2><p>优点：解耦、削峰、数据分发。</p>
<p>缺点：</p>
<ul>
<li><p>系统可用性降低</p>
<p>外部依赖越多，稳定性越差，一旦MQ宕机，就会对业务造成影响。</p>
</li>
<li><p>系统复杂度提高</p>
</li>
<li><p>一致性问题</p>
</li>
</ul>
<h2 id="1-3-MQ产品比较"><a href="#1-3-MQ产品比较" class="headerlink" title="1.3 MQ产品比较"></a>1.3 MQ产品比较</h2><p><a href="https://www.cnblogs.com/nov5026/archive/2018/08/22/9518520.html" target="_blank" rel="noopener">https://www.cnblogs.com/nov5026/archive/2018/08/22/9518520.html</a></p>
<h1 id="RocketMq快速入门"><a href="#RocketMq快速入门" class="headerlink" title="RocketMq快速入门"></a>RocketMq快速入门</h1><h2 id="2-1准备工作"><a href="#2-1准备工作" class="headerlink" title="2.1准备工作"></a>2.1准备工作</h2><h3 id="下载RocketMq"><a href="#下载RocketMq" class="headerlink" title="下载RocketMq"></a>下载RocketMq</h3><p><a href="http://rocketmq.apache.org/" target="_blank" rel="noopener">http://rocketmq.apache.org/</a></p>
<p>版本4.7.0</p>
<h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><ul>
<li>Linux64位环境</li>
<li>JDK1.8</li>
<li>源码安装需要安装Maven 3.2.x</li>
</ul>
<h2 id="2-2-安装RocketMQ"><a href="#2-2-安装RocketMQ" class="headerlink" title="2.2 安装RocketMQ"></a>2.2 安装RocketMQ</h2><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><p>以二进制包进行安装</p>
<ol>
<li>解压安装包</li>
<li>进入安装目录</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip rocketmq-all-4.7.0-bin-release.zip</span><br></pre></td></tr></table></figure>



<h3 id="目录介绍"><a href="#目录介绍" class="headerlink" title="目录介绍"></a>目录介绍</h3><ul>
<li>bin: 启动脚本，包括shell脚本和cmd脚本</li>
<li>conf：实例配置文件，包括broker配置文件，logback配置文件等</li>
<li>lib：依赖jar包，包括netty，commons-lang,FastJson等</li>
</ul>
<h2 id="2-3启动RocketMQ"><a href="#2-3启动RocketMQ" class="headerlink" title="2.3启动RocketMQ"></a>2.3启动RocketMQ</h2><ol>
<li>启动NameServer</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.启动NameServer</span></span><br><span class="line">nohup sh bin/mqnamesrv &amp;</span><br><span class="line"><span class="comment"># 2.查看启动日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动broker</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.启动broker</span></span><br><span class="line">nohup sh bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line"><span class="comment"># 2.查看启动日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<ul>
<li><p>问题描述</p>
<p>RocketMQ默认的虚拟机内存较大，启动Broker如果因为内存不足失败，需要编辑如下两个配置文件，修改JVM内存大小</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim runbroker.sh</span><br><span class="line">vim runserver.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>参考设置</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms128m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span></span><br></pre></td></tr></table></figure>

<h2 id="2-4测试RocketMQ"><a href="#2-4测试RocketMQ" class="headerlink" title="2.4测试RocketMQ"></a>2.4测试RocketMQ</h2><h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="comment"># 2.使用安装包的Demo发送信息</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>

<h3 id="接受消息"><a href="#接受消息" class="headerlink" title="接受消息"></a>接受消息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="comment"># 2.接受消息</span></span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Comsumer</span><br></pre></td></tr></table></figure>



<h2 id="2-5-关闭RocketMQ"><a href="#2-5-关闭RocketMQ" class="headerlink" title="2.5 关闭RocketMQ"></a>2.5 关闭RocketMQ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.关闭NameServer</span></span><br><span class="line">sh bin/mqshutdown namesrv</span><br><span class="line"><span class="comment"># 2.关闭Broker</span></span><br><span class="line">sh bin/mqshutdown broker</span><br></pre></td></tr></table></figure>

<h1 id="RocketMQ集群搭建"><a href="#RocketMQ集群搭建" class="headerlink" title="RocketMQ集群搭建"></a>RocketMQ集群搭建</h1><h2 id="3-1各角色介绍"><a href="#3-1各角色介绍" class="headerlink" title="3.1各角色介绍"></a>3.1各角色介绍</h2><ul>
<li>Producer：消息的发送者。</li>
<li>Consumer：消息的接收者。</li>
<li>Broker：暂存和传递消息。</li>
<li>NameServer：管理Broker。</li>
<li>Topic：区分消息的分类；一个发送者发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或多个Topic消息。</li>
<li>MessageQueue：相当于是Topic的分区；用于并行发送和接收消息。</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/5ed6606cc2a9a83be5e5e6c1.jpg" alt=""></p>
<h2 id="3-2-集群搭建方式"><a href="#3-2-集群搭建方式" class="headerlink" title="3.2 集群搭建方式"></a>3.2 集群搭建方式</h2><h3 id="集群特点"><a href="#集群特点" class="headerlink" title="集群特点"></a>集群特点</h3><ul>
<li>NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</li>
<li>Broker部署相对复杂，Broker分为Master和Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master和Slave的对应关系通过指定相同的BrokerName，不同的BrokerId来定义，BrokerId为0代表Master，非0代表Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。</li>
<li>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</li>
<li>Consumer与NameServer集群中其中一个节点（随机选择）建立长连接，定期从NameServer取路由信息，并向提供Topic服务器的Master和Slave建立长连接，且定时向Master和Slave发送心跳。Consumer既可以从Master订阅信息，也可以从Slave订阅信息，订阅规则由Broker决定。</li>
</ul>
<h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><p><strong>单Master模式</strong></p>
<p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用，可用于本地测试。</p>
<p><strong>多Master模式</strong></p>
<p>一个集群无Slave，全是Master，例如2个或者3个Master。</p>
<ul>
<li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢失（异步刷盘丢失少了信息，同步刷盘一条不丢），性能最高。</li>
<li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</li>
</ul>
<p><strong>多Master多Slave模式（异步）</strong></p>
<p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p>
<ul>
<li>优点：即使磁盘损坏，消息丢失非常少，且消息实时性不受影响，同时Master宕机后，消费者仍然从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样。</li>
<li>缺点：Master宕机，磁盘损坏情况下会丢失少量信息。</li>
</ul>
<p><strong>多Master多Slave模式（同步）</strong></p>
<p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即主备都写成功，才向应用返回成功。</p>
<ul>
<li>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高。</li>
<li>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT略高，且在目前版本主节点宕机后，备机不能自动切换为主机。</li>
</ul>
<h2 id="3-3-双主双从集群搭建"><a href="#3-3-双主双从集群搭建" class="headerlink" title="3.3 双主双从集群搭建"></a>3.3 双主双从集群搭建</h2><h3 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h3><p><img src="https://pic.imgdb.cn/item/5ed8f998c2a9a83be58351d9.jpg" alt=""></p>
<h3 id="集群工作流程"><a href="#集群工作流程" class="headerlink" title="集群工作流程"></a>集群工作流程</h3><p>1.启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</p>
<p>2.Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息（IP+端口等）以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</p>
<p>3.收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</p>
<p>4.Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发送消息。</p>
<p>5.Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</p>
<h3 id="服务器环境"><a href="#服务器环境" class="headerlink" title="服务器环境"></a>服务器环境</h3><table>
<thead>
<tr>
<th>序号</th>
<th>IP</th>
<th>角色</th>
<th>架构模式</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>192.168.25.xxx</td>
<td>nameserver,broker</td>
<td>Master1,Slave2</td>
</tr>
<tr>
<td>2</td>
<td>192.168.25.yyy</td>
<td>nameserver,broker</td>
<td>Master2，Salve1</td>
</tr>
</tbody></table>
<h3 id="Host添加信息"><a href="#Host添加信息" class="headerlink" title="Host添加信息"></a>Host添加信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure>

<p>配置如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nameserver</span></span><br><span class="line">192.168.1.6 rocketmq-nameserver1</span><br><span class="line">192.168.1.7 rocketmq-nameserver2</span><br><span class="line"><span class="comment"># broker</span></span><br><span class="line">192.168.1.6 rocketmq-master1</span><br><span class="line">192.168.1.6 rocketmq-slave2</span><br><span class="line">192.168.1.7 rocketmq-master2</span><br><span class="line">192.168.1.7 rocketmq-slave1</span><br></pre></td></tr></table></figure>

<p>完成后重启网卡,centos8是</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli c reload</span><br></pre></td></tr></table></figure>

<h3 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h3><p>宿主机需要远程访问虚拟机的rocketmq服务和web服务，需要开放相关的端口号，简单粗暴的方式是直接关闭防火墙。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemclt stop firewalld.service</span><br><span class="line"><span class="comment"># 查看防火墙状态</span></span><br><span class="line">firewall-cmd --state</span><br><span class="line"><span class="comment"># 禁止firewall开机启动</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<p>或者为了安全，只开放特定端口，RocketMQ默认使用3个端口:9876、10911、11011。如果防火墙没有关闭的话，那么防火墙必须开放这些端口。</p>
<ul>
<li>nameserver 默认使用9876端口</li>
<li>master 默认使用10911端口</li>
<li>slave 默认使用11011端口</li>
</ul>
<p>执行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放name server默认端口</span></span><br><span class="line">firewall-cmd --remove-port=9876/tcp --permanet</span><br><span class="line"><span class="comment"># 开放master默认端口</span></span><br><span class="line">firewall-cmd --remove-port=10911/tcp --permanet</span><br><span class="line"><span class="comment"># 开放slave默认端口(当前集群模式可不开启)</span></span><br><span class="line">firewall-cmd --remove-port=11011/tcp --permanet</span><br><span class="line"><span class="comment"># 重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>

<p>在profile文件的末尾加入如下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set rocketmq</span></span><br><span class="line">ROCKETMQ_HOME=/opt/rocketmq-all-4.7.0-bin-release</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$ROCKETMQ_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> ROCKETMQ_HOME PATH</span><br></pre></td></tr></table></figure>

<p>输入:wq保存并退出，并使得配置立即生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="创建消息存储路径"><a href="#创建消息存储路径" class="headerlink" title="创建消息存储路径"></a>创建消息存储路径</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/rocketmq/store</span><br><span class="line">mkdir /opt/rocketmq/store/commitlog</span><br><span class="line">mkdir /opt/rocketmq/store/consumequeue</span><br><span class="line">mkdir /opt/rocketmq/store/index</span><br></pre></td></tr></table></figure>

<h3 id="broker配置文件"><a href="#broker配置文件" class="headerlink" title="broker配置文件"></a>broker配置文件</h3><p><strong>master1</strong></p>
<p>服务器：192.168.1.6</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-a.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment"># broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker<span class="_">-a</span></span><br><span class="line"><span class="comment">#0 表示 Master， &gt;0 表示 slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨4点</span></span><br><span class="line">deletewhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReserveredTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30w条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/opt/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/opt/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径</span></span><br><span class="line">storePathConsumeQueue=/opt/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消费索引存储路径</span></span><br><span class="line">storePathIndex=/opt/rocketmq/store/index</span><br><span class="line"><span class="comment"># checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/opt/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储地址</span></span><br><span class="line">abortFile=/opt/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制消息的大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment"># Broker的角色</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER 同步双写MASTER</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment"># 刷盘方式</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br></pre></td></tr></table></figure>

<p><strong>Slave2</strong></p>
<p>服务器：192.168.1.6</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-b-s.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment"># broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master， &gt;0 表示 slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨4点</span></span><br><span class="line">deletewhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReserveredTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30w条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/opt/rocketmq/store1</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/opt/rocketmq/store1/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径</span></span><br><span class="line">storePathConsumeQueue=/opt/rocketmq/store1/consumequeue</span><br><span class="line"><span class="comment">#消费索引存储路径</span></span><br><span class="line">storePathIndex=/opt/rocketmq/store1/index</span><br><span class="line"><span class="comment"># checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/opt/rocketmq/store1/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储地址</span></span><br><span class="line">abortFile=/opt/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制消息的大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment"># Broker的角色</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER 同步双写MASTER</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment"># 刷盘方式</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure>

<p><strong>Master2</strong></p>
<p>服务器：192.168.1.7</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-b.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment"># broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master， &gt;0 表示 slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨4点</span></span><br><span class="line">deletewhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReserveredTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30w条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/opt/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/opt/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径</span></span><br><span class="line">storePathConsumeQueue=/opt/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消费索引存储路径</span></span><br><span class="line">storePathIndex=/opt/rocketmq/store/index</span><br><span class="line"><span class="comment"># checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/opt/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储地址</span></span><br><span class="line">abortFile=/opt/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制消息的大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment"># Broker的角色</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER 同步双写MASTER</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment"># 刷盘方式</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br></pre></td></tr></table></figure>

<p><strong>Slave2</strong></p>
<p>服务器：192.168.1.7</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties</span><br></pre></td></tr></table></figure>

<p>修改配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment"># broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker<span class="_">-a</span></span><br><span class="line"><span class="comment">#0 表示 Master， &gt;0 表示 slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨4点</span></span><br><span class="line">deletewhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReserveredTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30w条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/opt/rocketmq/store1</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/opt/rocketmq/store1/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径</span></span><br><span class="line">storePathConsumeQueue=/opt/rocketmq/store1/consumequeue</span><br><span class="line"><span class="comment">#消费索引存储路径</span></span><br><span class="line">storePathIndex=/opt/rocketmq/store1/index</span><br><span class="line"><span class="comment"># checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/opt/rocketmq/store1/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储地址</span></span><br><span class="line">abortFile=/opt/rocketmq/store1/abort</span><br><span class="line"><span class="comment">#限制消息的大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment"># Broker的角色</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER 同步双写MASTER</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment"># 刷盘方式</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure>

<h3 id="修改启动脚本文件"><a href="#修改启动脚本文件" class="headerlink" title="修改启动脚本文件"></a>修改启动脚本文件</h3><p><strong>runbroker.sh</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /bin/runbroker.sh</span><br></pre></td></tr></table></figure>

<p>需要根据内存大小进行适当的对JVM参数进行调整：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开发环境配置 JVM Configuration</span></span><br><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m"</span></span><br></pre></td></tr></table></figure>

<p><strong>runserver.sh</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /bin/runserver.sh</span><br></pre></td></tr></table></figure>

<p>需要根据内存大小进行适当的对JVM参数进行调整：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span></span><br></pre></td></tr></table></figure>

<h3 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h3><p><strong>启动NameServer集群</strong></p>
<p>分别在两台集群启动NameServer</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /bin</span><br><span class="line">nohup sh mqnamesrv &amp;</span><br></pre></td></tr></table></figure>

<p><strong>启动Broker集群</strong></p>
<p>master1：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /bin</span><br><span class="line">nohup sh mqbroker -c /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-a.properties &amp;</span><br></pre></td></tr></table></figure>

<p>slave2：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /bin</span><br><span class="line">nohup sh mqbroker -c /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure>

<p>master2：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /bin</span><br><span class="line">nohup sh mqbroker -c /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker-b.properties &amp;</span><br></pre></td></tr></table></figure>

<p>slave1：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /bin</span><br><span class="line">nohup sh mqbroker -c /opt/rocketmq-all-4.7.0-bin-release/conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br></pre></td></tr></table></figure>

<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nameSrv日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line"><span class="comment"># broker日志</span></span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<p><strong>易错点</strong></p>
<p>中间遇到无法启动broker的情况，是因为使用了同一个storePath，改一下就好。</p>
<h2 id="3-4-mqadmin-管理工具"><a href="#3-4-mqadmin-管理工具" class="headerlink" title="3.4 mqadmin 管理工具"></a>3.4 mqadmin 管理工具</h2><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>进入mq安装位置，在bin目录下执行 ./mqadmin {command} {args}</p>
<h3 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h3><p>略</p>
<h3 id="3-5-集群监控平台搭建"><a href="#3-5-集群监控平台搭建" class="headerlink" title="3.5 集群监控平台搭建"></a>3.5 集群监控平台搭建</h3><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>我们需要自己对rocketmq-console进行编译打包运行。</p>
<p><a href="https://github.com/apache/rocketmq-externals" target="_blank" rel="noopener">https://github.com/apache/rocketmq-externals</a></p>
<h4 id="3-5-2-下载并编译打包"><a href="#3-5-2-下载并编译打包" class="headerlink" title="3.5.2 下载并编译打包"></a>3.5.2 下载并编译打包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;apache&#x2F;rocketmq-externals</span><br><span class="line">cd rocketmq-console</span><br><span class="line">mvn clean package -Dmaven.test.skip&#x3D;true</span><br></pre></td></tr></table></figure>

<p>注意：打包前在rocket-console中配置namesrv集群地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rocketmq.config.namesrvAddr&#x3D;192.168.1.6:9876;192.168.1.7:9876;</span><br></pre></td></tr></table></figure>

<p>上传到linux服务器上，启动rocketmq-console：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar rocketmq-console-ng-1.0.0.jar</span><br></pre></td></tr></table></figure>

<p>启动成功，我们就可以通过浏览器<a href="http://localhost:8080进入控制台界面了。">http://localhost:8080进入控制台界面了。</a></p>
<h1 id="消息发送样例"><a href="#消息发送样例" class="headerlink" title="消息发送样例"></a>消息发送样例</h1><ul>
<li><p>创建maven项目并导入客户端依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>消息发送者步骤分析</p>
</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 创建消息生产者producer,并指定生产者组名。</span><br><span class="line">2. 指定NameServer地址</span><br><span class="line">3. 启动producer</span><br><span class="line">4. 创建消息对象，指定主题Topic、Tag和消息体</span><br><span class="line">5. 发送消息</span><br><span class="line">6. 关闭生产者Producer</span><br></pre></td></tr></table></figure>

<ul>
<li>消息消费者步骤分析</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 创建消费者Consumer，指定消费者组名</span><br><span class="line">2. 指定NameServer地址</span><br><span class="line">3. 订阅主题Topic和Tag</span><br><span class="line">4. 设置回调函数，处理消息</span><br><span class="line">5. 启动消费者Consumer</span><br></pre></td></tr></table></figure>

<h2 id="4-1-基本样例"><a href="#4-1-基本样例" class="headerlink" title="4.1 基本样例"></a>4.1 基本样例</h2><h3 id="4-1-1-消息发送"><a href="#4-1-1-消息发送" class="headerlink" title="4.1.1 消息发送"></a>4.1.1 消息发送</h3><h4 id="1）发送同步消息"><a href="#1）发送同步消息" class="headerlink" title="1）发送同步消息"></a>1）发送同步消息</h4><p>这种可靠性同步地发送方式使用比较广泛，比如：重要的消息通知，短信通知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"base"</span>,</span><br><span class="line">                        <span class="string">"Tag1"</span>, (<span class="string">"Hello MQ"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line">                SendStatus status = sendResult.getSendStatus();</span><br><span class="line">                String msgId = sendResult.getMsgId();</span><br><span class="line">                <span class="keyword">int</span> queueId = sendResult.getMessageQueue().getQueueId();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                System.out.printf(<span class="string">"发送状态：%s 消息id：%s 队列id:%d\n"</span>, status, msgId, queueId);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-发送异步消息"><a href="#2-发送异步消息" class="headerlink" title="2)  发送异步消息"></a>2)  发送异步消息</h4><p>异步消息通常用在响应时间敏感的业务场景，即发送端不能容忍长时间等待Broker的响应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"base"</span>,</span><br><span class="line">                        <span class="string">"Tag1"</span>, (<span class="string">"Async Hello MQ"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(SendResult sendResult)</span> </span>&#123;</span><br><span class="line">                        SendStatus status = sendResult.getSendStatus();</span><br><span class="line">                        String msgId = sendResult.getMsgId();</span><br><span class="line">                        <span class="keyword">int</span> queueId = sendResult.getMessageQueue().getQueueId();</span><br><span class="line">                        System.out.printf(<span class="string">"发送状态：%s 消息id：%s 队列id:%d\n"</span>, status, msgId, queueId);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        System.out.printf(<span class="string">"%-10d Exception %s %n"</span>, index, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-单向消息"><a href="#3-单向消息" class="headerlink" title="3) 单向消息"></a>3) 单向消息</h4><p>不在乎消息的发送状态，比如日志等消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneWayProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"base"</span>,</span><br><span class="line">                        <span class="string">"Tag1"</span>, (<span class="string">"Hello MQ 单向消息"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                System.out.printf(<span class="string">"发送状态：%n\n"</span>, i);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-消费消息"><a href="#4-1-2-消费消息" class="headerlink" title="4.1.2 消费消息"></a>4.1.2 消费消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneWayProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"base"</span>,</span><br><span class="line">                        <span class="string">"Tag2"</span>, (<span class="string">"Hello MQ 单向消息"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                System.out.printf(<span class="string">"发送状态：%n\n"</span>, i);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1）-负载均衡模式"><a href="#1）-负载均衡模式" class="headerlink" title="1） 负载均衡模式"></a>1） 负载均衡模式</h4><p>消费者采用负载均衡模式方法消费消息，多个消费者共同消费队列消息，每个消费者处理的消息不同。 默认为负载均衡。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.protocol.heartbeat.MessageModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClusterConsumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建消费者Consumer，指定消费者组名</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">//2. 指定NameServer地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//3. 订阅主题Topic和Tag</span></span><br><span class="line">        consumer.subscribe(<span class="string">"base"</span>, <span class="string">"Tag1"</span>);</span><br><span class="line">        <span class="comment">//设置负载均衡</span></span><br><span class="line">        consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line">        <span class="comment">//4. 设置回调函数，处理消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            <span class="comment">//接收消息内容</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; list, ConsumeConcurrentlyContext consumeConcurrentlyContext)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt per : list) &#123;</span><br><span class="line">                    System.out.println(<span class="string">" 负载均衡"</span> + <span class="keyword">new</span> String(per.getBody()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5. 启动消费者Consumer</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）广播模式"><a href="#2）广播模式" class="headerlink" title="2）广播模式"></a>2）广播模式</h4><p>消费者采用广播的方式消费消息，每个消费者的消息是相同的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.base.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.protocol.heartbeat.MessageModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClusterConsumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建消费者Consumer，指定消费者组名</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">//2. 指定NameServer地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//3. 订阅主题Topic和Tag</span></span><br><span class="line">        consumer.subscribe(<span class="string">"base"</span>, <span class="string">"Tag1"</span>);</span><br><span class="line">        <span class="comment">//设置负载均衡</span></span><br><span class="line">        consumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class="line">        <span class="comment">//4. 设置回调函数，处理消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            <span class="comment">//接收消息内容</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; list, ConsumeConcurrentlyContext consumeConcurrentlyContext)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt per : list) &#123;</span><br><span class="line">                    System.out.println(<span class="string">" 负载均衡"</span> + <span class="keyword">new</span> String(per.getBody()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5. 启动消费者Consumer</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-顺序消息"><a href="#4-2-顺序消息" class="headerlink" title="4.2 顺序消息"></a>4.2 顺序消息</h2><p>​    消息有序指的是可以按照消息的发送顺序来消费消息(FIFO)。RocketMq可以严格的保证消息有序。可以分为分区有序或者全局有序。</p>
<p>​    顺序消费的原理解析，在默认情况下消息发送会采取Round Robin轮询方式把消息发送到不同的queue(分区队列)；而消费消息时从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序只依次发送到同一个queue中，消费的时候只从这个queue依次拉取，则保证了顺序。当发送和消费参与的queue只有一个，则是全局有序；如果有多个queue参与，则是分区有序，即相对于每个queue，消息都是有序的。</p>
<h3 id="4-2-1-顺序消息生产"><a href="#4-2-1-顺序消息生产" class="headerlink" title="4.2.1 顺序消息生产"></a>4.2.1 顺序消息生产</h3><p>​    下面用订单进行分区有序的示例。一个订单的顺序：创建、付款、推送、完成。订单相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建消息集合</span></span><br><span class="line">        List&lt;OrderStep&gt; orderStepList = OrderStep.buildOrders();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//发送消息</span></span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (OrderStep per : orderStepList) &#123;</span><br><span class="line">                String body = per + <span class="string">""</span>;</span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"OrderTopic"</span>, <span class="string">"Order"</span>, <span class="string">"i"</span> + i, body.getBytes());</span><br><span class="line">                <span class="comment">//参数一：消息对象</span></span><br><span class="line">                <span class="comment">//参数二：消息队列选择器</span></span><br><span class="line">                <span class="comment">//参数三：选择队列的业务标识（订单id）</span></span><br><span class="line"></span><br><span class="line">                SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> list    : 队列集合</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> message : 消息对象</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@param</span> o 业务标识参数</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@author</span> soriee</span></span><br><span class="line"><span class="comment">                     * <span class="doctag">@date</span> 2020/6/30 22:03</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; list, Message message, Object o)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">long</span> orderId = (Long) o;</span><br><span class="line">                        <span class="keyword">int</span> index = (<span class="keyword">int</span>) (orderId % list.size());</span><br><span class="line">                        System.out.println(<span class="string">"队列 "</span> + index);</span><br><span class="line">                        <span class="keyword">return</span> list.get(index);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, per.getOrderId());</span><br><span class="line">                System.out.println(<span class="string">"发送成功: "</span> + sendResult.toString());</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-顺序消息消费"><a href="#4-2-2-顺序消息消费" class="headerlink" title="4.2.2 顺序消息消费"></a>4.2.2 顺序消息消费</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建消费者Consumer，指定消费者组名</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">//2. 指定NameServer地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//3. 订阅主题Topic和Tag</span></span><br><span class="line">        consumer.subscribe(<span class="string">"OrderTopic"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">//4. 设置回调函数，处理消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerOrderly() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeOrderlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; list, ConsumeOrderlyContext consumeOrderlyContext)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt per : list) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"线程名称【"</span> + Thread.currentThread().getName() + <span class="string">"】 消费消息："</span> + <span class="keyword">new</span> String(per.getBody()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5. 启动消费者Consumer</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-延时消息"><a href="#4-3-延时消息" class="headerlink" title="4.3 延时消息"></a>4.3 延时消息</h2><p>​    比如电商里，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p>
<h3 id="4-3-1-启动消息消费者"><a href="#4-3-1-启动消息消费者" class="headerlink" title="4.3.1 启动消息消费者"></a>4.3.1 启动消息消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.delay;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//1. 创建消费者Consumer，指定消费者组名</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">//2. 指定NameServer地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//3. 订阅主题Topic和Tag</span></span><br><span class="line">        consumer.subscribe(<span class="string">"topicDelay"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">//4. 设置回调函数，处理消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerOrderly() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeOrderlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; list, ConsumeOrderlyContext consumeOrderlyContext)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt per : list) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"线程名称【"</span> + Thread.currentThread().getName() + <span class="string">"】 消费消息："</span> + <span class="keyword">new</span> String(per.getBody()) + System.currentTimeMillis());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5. 启动消费者Consumer</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-发送延时消息"><a href="#4-3-2-发送延时消息" class="headerlink" title="4.3.2 发送延时消息"></a>4.3.2 发送延时消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.delay;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"topicDelay"</span>,</span><br><span class="line">                        <span class="string">"Tag1"</span>, (<span class="string">"Hello MQ 延时消息"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                msg.setDelayTimeLevel(<span class="number">2</span>);</span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line">                SendStatus status = sendResult.getSendStatus();</span><br><span class="line">                String msgId = sendResult.getMsgId();</span><br><span class="line">                <span class="keyword">int</span> queueId = sendResult.getMessageQueue().getQueueId();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                System.out.printf(<span class="string">"发送状态：%s 消息id：%s 队列id:%d\n"</span>, status, msgId, queueId);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-验证"><a href="#4-3-3-验证" class="headerlink" title="4.3.3 验证"></a>4.3.3 验证</h3><p>您将会看到消息的消费比存储时间晚10秒</p>
<h3 id="4-3-4-使用限制"><a href="#4-3-4-使用限制" class="headerlink" title="4.3.4 使用限制"></a>4.3.4 使用限制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq/store/config/MessageStoreConfig.java</span></span><br><span class="line"><span class="keyword">private</span> String messageDelayLevel = <span class="string">"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span></span><br></pre></td></tr></table></figure>

<p>现在RocketMq并不支持任意时间的延时，需要设置几个固定延时等级，从1s到2h对应等级1到18</p>
<h2 id="4-4-批量消息"><a href="#4-4-批量消息" class="headerlink" title="4.4 批量消息"></a>4.4 批量消息</h2><p>​    批量消息能够显著提高传递小消息的性能，限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批的消息总大小应不超过4MB。</p>
<h3 id="4-4-1-发送批量消息"><a href="#4-4-1-发送批量消息" class="headerlink" title="4.4.1 发送批量消息"></a>4.4.1 发送批量消息</h3><p>​    如果您每次只发送4MB不到的消息，则很容易批处理，样例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String topic = <span class="string">"BatchTest"</span>;</span><br><span class="line">List&lt;Message&gt; msgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">msgs.add(<span class="keyword">new</span> Message(topic), <span class="string">"TagA"</span>, <span class="string">"OrderID001"</span>, <span class="string">"Hello World 0"</span>.getBytes);</span><br><span class="line">msgs.add(<span class="keyword">new</span> Message(topic), <span class="string">"TagA"</span>, <span class="string">"OrderID001"</span>, <span class="string">"Hello World 0"</span>.getBytes);</span><br><span class="line">msgs.add(<span class="keyword">new</span> Message(topic), <span class="string">"TagA"</span>, <span class="string">"OrderID001"</span>, <span class="string">"Hello World 0"</span>.getBytes);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    producer.send(msgs);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    如果消费的总长度可能大于4MB时，这时候最好把消费进行分割。</p>
<p>创建一个分割器</p>
<p>一个消息的长度=topic长度和body长度以及消息额外的属性以及日志开销20字节。</p>
<p><img src="https://pic.imgdb.cn/item/5efde28e14195aa594a1ce17.jpg" alt=""></p>
<h2 id="4-5-过滤消息"><a href="#4-5-过滤消息" class="headerlink" title="4.5 过滤消息"></a>4.5 过滤消息</h2><p>​    在大多数情况下,TAG是一个简单而有用的，其可以选择您想要的消息。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"CID_EXAMPLE"</span>);</span><br><span class="line">consumer.subscribe(<span class="string">"TOPIC"</span>, <span class="string">"TAGA || TAGB || TAGC"</span>);</span><br></pre></td></tr></table></figure>

<p>​    消费者将接收TAGA或TAGB或TAGC的消息。但是限制是一个消息只能有一个标签，这对复杂的场景可能不起作用。在这种情况下，可以使用SQL表达式筛选我消息。SQL特性可以通过发送消息时的属性来进行计算。在RocketMQ定义的语法下，实现一些简单的逻辑。下面是一个例子：</p>
<p>​    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----------</span><br><span class="line">|message   |</span><br><span class="line">|----------|  a &gt; 5 AND b &#x3D; &#39;abc&#39;  </span><br><span class="line">|a&#x3D;10      |   ---&gt;Gotten</span><br><span class="line">|b&#x3D;&#39;abc&#39;   |</span><br><span class="line">|c&#x3D;true    |</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">----------</span><br><span class="line">|message   |  a &gt; 5 AND b &#x3D; &#39;abc&#39;  </span><br><span class="line">|----------|  ---&gt; Missing</span><br><span class="line">|a&#x3D;1      |</span><br><span class="line">|b&#x3D;&#39;abc&#39;   |</span><br><span class="line">|c&#x3D;true    |</span><br><span class="line">------------</span><br></pre></td></tr></table></figure>

<h3 id="4-5-1-SQL基本语法"><a href="#4-5-1-SQL基本语法" class="headerlink" title="4.5.1 SQL基本语法"></a>4.5.1 SQL基本语法</h3><p>RocketMQ只定义了一些基本语法来支持这个特性，你也可以很容易地扩展它。</p>
<ul>
<li>数值比较, &gt;, &gt;= , &lt;, &lt;=, BETWEEN, =;</li>
<li>字符比较,比如：=，&lt;&gt;, IN;</li>
<li>IS NULL或者 IS NOT NULL</li>
<li>逻辑符号 AND OR NOT；</li>
</ul>
<p>支持的类型有：</p>
<ul>
<li>数值，整数和小数</li>
<li>字符，必须用单引号括起来</li>
<li>NULL, 特殊的常量</li>
<li>布尔值，TRUE或者FALSE</li>
</ul>
<p>只有使用push模式的消费者才能够使用SQL92标准的sql语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subcribe</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> MessageSelector messageSelector)</span></span></span><br></pre></td></tr></table></figure>


<h3 id="4-5-2-消息生产者"><a href="#4-5-2-消息生产者" class="headerlink" title="4.5.2 消息生产者"></a>4.5.2 消息生产者</h3><p>发送消息时，可以通过putUserProperty来设置消息的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg.setUserProperty(<span class="string">"i"</span>, String.valueOf(i));</span><br></pre></td></tr></table></figure>



<h3 id="4-5-3-消息消费者"><a href="#4-5-3-消息消费者" class="headerlink" title="4.5.3 消息消费者"></a>4.5.3 消息消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer.subcribe(<span class="string">"FilterSqlTopic"</span>, MessageSelector.bySql(<span class="string">"i&gt;5"</span>));</span><br></pre></td></tr></table></figure>

<h2 id="4-6-事务消息"><a href="#4-6-事务消息" class="headerlink" title="4.6 事务消息"></a>4.6 事务消息</h2><h3 id="4-6-1-流程分析"><a href="#4-6-1-流程分析" class="headerlink" title="4.6.1  流程分析"></a>4.6.1  流程分析</h3><p><img src="https://pic.imgdb.cn/item/5eff3c6414195aa59424388d.jpg" alt=""></p>
<p>上图大致说明了事务消息的大致方案，分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程</p>
<h4 id="1）事务消息发送及提交"><a href="#1）事务消息发送及提交" class="headerlink" title="1）事务消息发送及提交"></a>1）事务消息发送及提交</h4><ol>
<li>发送消息（half消息）。</li>
<li>服务端响应消息写入结果。</li>
<li>根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）。</li>
<li>根据本地事务状态Commit或者RollBack(Commit操作生成消息索引，消息对消费者可见)。</li>
</ol>
<h4 id="2）消息补偿"><a href="#2）消息补偿" class="headerlink" title="2）消息补偿"></a>2）消息补偿</h4><ol>
<li>对没有Commit和Rollback的事务消息(pending状态消息)，从服务端发起一次回查</li>
<li>Producer收到回查消息，检查回查消息的本地事务的状态</li>
<li>根据本地事务状态，重新Commit或者RollBack</li>
</ol>
<p>其中，补偿阶段用户解决消息Commit或者RollBack发生超时或者失败的情况</p>
<h4 id="3）事务消息状态"><a href="#3）事务消息状态" class="headerlink" title="3）事务消息状态"></a>3）事务消息状态</h4><p>事务消息共有三种状态：提交状态、回滚状态、中间状态：</p>
<ul>
<li>TransactionStatus.CommitTransaction:提交事务，它允许消费者消费此消息</li>
<li>TransactionStatus.RollBackTransaction: 回滚事务，它代表该消息将被删除，不允许被消费</li>
<li>TransactionStatus.UnKnown：中间状态，它代表需要检查消息队列来确定状态</li>
</ul>
<h3 id="4-6-2-发送事务消息"><a href="#4-6-2-发送事务消息" class="headerlink" title="4.6.2 发送事务消息"></a>4.6.2 发送事务消息</h3><h4 id="1-创建事务性生产者"><a href="#1-创建事务性生产者" class="headerlink" title="1) 创建事务性生产者"></a>1) 创建事务性生产者</h4><p>​    使用TransactionMQProducer类创建生产者，并指定唯一的ProducerGroup，就可以设置自定义线程池来处理这些检查要求。执行本地事务后，需要根据执行结果对消息队列进行回复。回传的事务状态在请参考前一节。</p>
<p>​    //好像事务消息发送者关闭太快回查无法触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.mq.rocketmq.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//实例化生产者producer</span></span><br><span class="line">        TransactionMQProducer producer = <span class="keyword">new</span> TransactionMQProducer(<span class="string">"group5"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.1.6:9876;192.168.1.7:9876"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置消息事务的消息监听器</span></span><br><span class="line">        producer.setTransactionListener(<span class="keyword">new</span> TransactionListener() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//该方法中去执行本地事务</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message message, Object o)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.equals(<span class="string">"TAGA"</span>, message.getTags())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.equals(<span class="string">"TAGB"</span>, message.getTags())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//MQ进行消息事务状态的回查</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">                System.out.println(messageExt.getTags());</span><br><span class="line">                <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//启动producer</span></span><br><span class="line">        String[] tags = &#123;<span class="string">"TAGA"</span>, <span class="string">"TAGB"</span>, <span class="string">"TAGC"</span>&#125;;</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//创建消息 指定topic,Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TransactionTopic"</span>,</span><br><span class="line">                        tags[i], (<span class="string">"Hello MQ 事务消息"</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">//发送消息到一个broker</span></span><br><span class="line">                SendResult sendResult = producer.sendMessageInTransaction(msg, <span class="keyword">null</span>);</span><br><span class="line">                SendStatus status = sendResult.getSendStatus();</span><br><span class="line">                String msgId = sendResult.getMsgId();</span><br><span class="line">                <span class="keyword">int</span> queueId = sendResult.getMessageQueue().getQueueId();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送消息是否成功送达</span></span><br><span class="line">                System.out.printf(<span class="string">"发送状态：%s 消息id：%s 队列id:%d, %s\n"</span>, status, msgId, queueId, tags[i]);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//            int n = 100000;</span></span><br><span class="line"><span class="comment">//            while (true) &#123;</span></span><br><span class="line"><span class="comment">//                </span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            producer.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-3-使用限制"><a href="#4-6-3-使用限制" class="headerlink" title="4.6.3 使用限制"></a>4.6.3 使用限制</h3><ol>
<li>事务消息不支持延时消息和批量消息</li>
<li>为了避免单个消息检查太多次而导致半队列累计，我们默认将单个消息的检查次数限制为15次，但是用户可以通过Broker配置文件的trancationCheckMax参数修改此限制。如果已经检查某条消息超过N次的话，则丢弃此消息，并在默认情况下同时打印错误日志。用户可以通过重写AbstractTransactionCheckListener类来修改这个行为。</li>
<li>事务消息将在Broker配置文件中的参数transactionMsgTimeout这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用户属性CHECK_IMMUNITY_TIME_IN_SECONDS来改变这个限制，该参数优先于transactionMsgTimeout参数。</li>
<li>事务消息可能不止一次被检查或消费。</li>
<li>提交给用户的目标主题消息可能会失败，目前这一日志的记录而定。它的高可用性RocketMQ本身的高可用机制来保证，如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步双重写入机制。</li>
<li>事务消息的生产者ID不能与其他类型消息的生产者ID共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器通过它们的生产者ID查询到消费者。</li>
</ol>
<h1 id="案例介绍"><a href="#案例介绍" class="headerlink" title="案例介绍"></a>案例介绍</h1><h2 id="5-1-业务分析"><a href="#5-1-业务分析" class="headerlink" title="5.1 业务分析"></a>5.1 业务分析</h2><p>​    模拟电商网站购物场景下的下单和支付业务。</p>
<h3 id="1）下单"><a href="#1）下单" class="headerlink" title="1）下单"></a>1）下单</h3><p><img src="https://pic.imgdb.cn/item/5f00846714195aa594a01a01.jpg" alt=""></p>
<ol>
<li>用户请求订单系统下单</li>
<li>订单系统通过RPC调用订单服务下单</li>
<li>订单服务调用优惠券服务，扣减优惠券</li>
<li>订单服务调用库存服务，校验并扣减库存</li>
<li>订单服务调用用户服务，扣减用户余额</li>
<li>订单完成确认订单。</li>
</ol>
<h3 id="2）支付"><a href="#2）支付" class="headerlink" title="2）支付"></a>2）支付</h3><p><img src="https://pic.imgdb.cn/item/5f00853414195aa594a077df.jpg" alt=""></p>
<ol>
<li>用户请求支付系统</li>
<li>支付系统调用第三方支付平台API发起支付流程</li>
<li>用户通过第三方支付平台支付成功后，第三方支付平台回调支付系统</li>
<li>支付系统调用订单服务修改订单状态</li>
<li>支付系统调用积分服务添加积分</li>
<li>支付系统调用日志服务记录日志</li>
</ol>
<h2 id="5-2-问题分析"><a href="#5-2-问题分析" class="headerlink" title="5.2 问题分析"></a>5.2 问题分析</h2><h3 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h3><p>​    用户提交订单后，扣减库存成功、扣减优惠券成功、使用余额成功，但是在确认订单操作失败，需要对库存、优惠券、余额进行回退。如何保证数据的完整性。</p>
<p><img src="https://pic.imgdb.cn/item/5f00872014195aa594a15f0f.jpg" alt=""></p>
<h3 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h3><p>​    用户通过第三方支付平台支付成功后，第三方支付平台要回调API异步通知商家支付系统用户支付结果，支付系统根据支付结果修改订单状态、记录支付日志和给用户增加积分。</p>
<p>​    支付系统如何保证在收到第三方支付平台的异步通知时，如果快速给第三方支付凭条做出回应。</p>
<p>​    <img src="https://pic.imgdb.cn/item/5f00883114195aa594a1e2af.jpg" alt=""></p>
<p>通过MQ进行数据分发，提高系统处理性能。</p>
<p><img src="https://pic.imgdb.cn/item/5f00885414195aa594a1f3f9.jpg" alt=""></p>
<h1 id="技术分析"><a href="#技术分析" class="headerlink" title="技术分析"></a>技术分析</h1><h2 id="6-1-技术选型"><a href="#6-1-技术选型" class="headerlink" title="6.1 技术选型"></a>6.1 技术选型</h2><ul>
<li>Spring Boot</li>
<li>Dubbo</li>
<li>Zookeeper</li>
<li>RocketMQ</li>
<li>MySql</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/5f00893914195aa594a27427.jpg" alt=""></p>
<h2 id="6-2-SpringBoot整合RocketMQ"><a href="#6-2-SpringBoot整合RocketMQ" class="headerlink" title="6.2 SpringBoot整合RocketMQ"></a>6.2 SpringBoot整合RocketMQ</h2><p>​    下载rocketmq-spring 项目</p>
<p>​    <a href="https://github.com/apache/rocketmq-spring" target="_blank" rel="noopener">https://github.com/apache/rocketmq-spring</a></p>
<p>​    将rocketmq-spring安装到本地仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install -Dmaven.skip.test = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-1-消息生产者"><a href="#6-2-1-消息生产者" class="headerlink" title="6.2.1 消息生产者"></a>6.2.1 消息生产者</h3><h4 id="1-添加依赖"><a href="#1-添加依赖" class="headerlink" title="1) 添加依赖"></a>1) 添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.sorie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>rocketmq-producer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>rocketmq<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-spring-boot-starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-发送消息测试者"><a href="#2-发送消息测试者" class="headerlink" title="2) 发送消息测试者"></a>2) 发送消息测试者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.rocketmqproducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQTemplate;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= &#123;RocketmqProducerApplication<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Slf4j</span></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">RocketmqProducerApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">"springboot-rocketmq"</span>, <span class="string">"Hello Springboot RocketMq"</span>);</span><br><span class="line">        log.info(<span class="string">"发送消息"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）application-properties"><a href="#3）application-properties" class="headerlink" title="3）application.properties"></a>3）application.properties</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">rocketmq.name-server</span>=<span class="string">192.168.1.6:9876;192.168.1.7:9876;</span></span><br><span class="line"><span class="meta">rocketmq.producer.group</span>=<span class="string">my-grp</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-2-消息消费者"><a href="#6-2-2-消息消费者" class="headerlink" title="6.2.2 消息消费者"></a>6.2.2 消息消费者</h3><h4 id="1-添加依赖-1"><a href="#1-添加依赖-1" class="headerlink" title="1) 添加依赖"></a>1) 添加依赖</h4><p>同上</p>
<h4 id="2-消费者"><a href="#2-消费者" class="headerlink" title="2) 消费者"></a>2) 消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.rocketmqconsumer.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"springboot-rocketmq"</span>,</span><br><span class="line">        consumerGroup = <span class="string">"$&#123;rocketmq.producer.group&#125;"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"接收消息"</span> + s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）application-properties-1"><a href="#3）application-properties-1" class="headerlink" title="3）application.properties"></a>3）application.properties</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">rocketmq.name-server</span>=<span class="string">192.168.1.6:9876;192.168.1.7:9876;</span></span><br><span class="line"><span class="meta">rocketmq.producer.group</span>=<span class="string">my-grp</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-Spring-Boot整合Dubbo"><a href="#6-3-Spring-Boot整合Dubbo" class="headerlink" title="6.3 Spring Boot整合Dubbo"></a>6.3 Spring Boot整合Dubbo</h2><p>rpc远程调用</p>
<p>下载dubbo-spring-boot-starter依赖包</p>
<p>安装到本地仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install -Dmaven.skip.test = true</span><br></pre></td></tr></table></figure>

<p><img src="https://pic.imgdb.cn/item/5f01d3af14195aa59457b14c.jpg" alt=""></p>
<h3 id="6-3-1-搭建Zookeeper集群"><a href="#6-3-1-搭建Zookeeper集群" class="headerlink" title="6.3.1 搭建Zookeeper集群"></a>6.3.1 搭建Zookeeper集群</h3><h4 id="1）准备工作"><a href="#1）准备工作" class="headerlink" title="1）准备工作"></a>1）准备工作</h4><ol>
<li><p>安装JDK</p>
</li>
<li><p>将Zookeeper上传服务器</p>
</li>
<li><p>解压Zookeeper，并创建data目录，将conf下的zoo_sample.cfg文件名改为zoo.cfg</p>
</li>
<li><p>建立/user/local/zookeeper-cluster, 将解压后的Zookeeper复制到以下三个目录</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;user&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-1</span><br><span class="line">&#x2F;user&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-2</span><br><span class="line">&#x2F;user&#x2F;local&#x2F;zookeeper-cluster&#x2F;zookeeper-3</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>配置每一个Zookeeper的dataDir(zoo.cfg)clientPort 分别为 2181, 2182, 2183</li>
</ol>
<p>修改/user/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clientPort&#x3D;2181</span><br><span class="line">dataDir&#x3D;&#x2F;zookeeper-cluster&#x2F;zookeeper-1&#x2F;data</span><br></pre></td></tr></table></figure>

<p>​    其他也做如上改动</p>
<h4 id="2-配置集群"><a href="#2-配置集群" class="headerlink" title="2) 配置集群"></a>2) 配置集群</h4><ol>
<li>在每个zookeeper的data目录下创建一个myid文件，内容分别为1、2、3。这个文件就是记录每个服务器的id</li>
<li>在每个zookeeper的zoo.cfg配置客户端访问端口(clientPort)和集群服务器IP列表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1&#x3D;192.168.1.6:2881:3881</span><br><span class="line">server.1&#x3D;192.168.1.6:2882:3882</span><br><span class="line">server.1&#x3D;192.168.1.6:2883:3883</span><br></pre></td></tr></table></figure>

<p>解释：server.服务器 ID = 服务器IP地址:服务器之间通信端口:服务器之间投票选举端口</p>
<h4 id="3-启动集群"><a href="#3-启动集群" class="headerlink" title="3) 启动集群"></a>3) 启动集群</h4><p>启动集群就是分别启动每个实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2-RPC服务接口"><a href="#6-3-2-RPC服务接口" class="headerlink" title="6.3.2 RPC服务接口"></a>6.3.2 RPC服务接口</h3><p>项目结构</p>
<img src="https://pic.imgdb.cn/item/5f03265414195aa5940d489b.jpg" style="zoom:200%;" />

<p>在interface下添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.springbootdubboprovider.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-3-服务提供者"><a href="#6-2-3-服务提供者" class="headerlink" title="6.2.3 服务提供者"></a>6.2.3 服务提供者</h3><h4 id="1）依赖"><a href="#1）依赖" class="headerlink" title="1）依赖"></a>1）依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.sorie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>springboot-dubbo-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.sorie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.101tec/zkclient --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2）application-properties"><a href="#2）application-properties" class="headerlink" title="2）application.properties"></a>2）application.properties</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">dubbo-demo-provider</span></span><br><span class="line"><span class="meta">dubbo.application.id</span>=<span class="string">dubbo-demo-provider</span></span><br><span class="line"><span class="meta">dubbo.application.name</span>=<span class="string">dubbo-demo-provider</span></span><br><span class="line"><span class="meta">dubbo.registry.address</span>=<span class="string">zookeeper://192.168.1.6:2182;zookeeper://192.168.1.6:2181;zookeeper://192.168.1.6:2183;</span></span><br><span class="line"><span class="meta">dubbo.registry.client</span>=<span class="string">curator</span></span><br><span class="line"><span class="meta">dubbo.protocol.name</span>=<span class="string">dubbo</span></span><br><span class="line"><span class="meta">dubbo.protocol.port</span>=<span class="string">20880</span></span><br><span class="line"><span class="meta">dubbo.config-center.timeout</span>=<span class="string">10000</span></span><br><span class="line"><span class="meta">dubbo.scan.base-packages</span>=<span class="string">cn.sorie.springbootdubboprovider.service</span></span><br></pre></td></tr></table></figure>

<h4 id="3-启动类"><a href="#3-启动类" class="headerlink" title="3)启动类"></a>3)启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDubboConfig</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootDubboProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringbootDubboProviderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-服务实现"><a href="#4-服务实现" class="headerlink" title="4)服务实现"></a>4)服务实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.springbootdubboprovider.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-4-dubbo-admin搭建"><a href="#6-2-4-dubbo-admin搭建" class="headerlink" title="6.2.4 dubbo-admin搭建"></a>6.2.4 dubbo-admin搭建</h3><p>下载tomcat和dubbo-admin.war</p>
<p>将war包放入tomcat的webapps目录下，启动tomcat即可</p>
<p>然后访问即可</p>
<p><a href="http://192.168.1.6:8080/dubbo-admin" target="_blank" rel="noopener">http://192.168.1.6:8080/dubbo-admin</a></p>
<p>服务名和密码都是root</p>
<p>中间遇到8080端口被占用了，改为了8081端口</p>
<h3 id="6-2-4-服务消费者"><a href="#6-2-4-服务消费者" class="headerlink" title="6.2.4 服务消费者"></a>6.2.4 服务消费者</h3><h4 id="1）-添加依赖"><a href="#1）-添加依赖" class="headerlink" title="1） 添加依赖"></a>1） 添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.sorie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>springboot-dubbo-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2）配置文件"><a href="#2）配置文件" class="headerlink" title="2）配置文件"></a>2）配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo-demo-consumer</span></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo-demo-consumer</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">zookeeper://192.168.1.6:2182,192.168.1.6:2181,192.168.1.6:2183</span></span><br></pre></td></tr></table></figure>

<h4 id="3）启动类"><a href="#3）启动类" class="headerlink" title="3）启动类"></a>3）启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.springbootdubboconsumer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootDubboConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringbootDubboConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4）Controller"><a href="#4）Controller" class="headerlink" title="4）Controller"></a>4）Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.sorie.springbootdubboconsumer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.sorie.springbootdubboprovider.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@DubboReference</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@DubboReference</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-环境搭建"><a href="#7-环境搭建" class="headerlink" title="7. 环境搭建"></a>7. 环境搭建</h3><h2 id="7-1-数据库"><a href="#7-1-数据库" class="headerlink" title="7.1 数据库"></a>7.1 数据库</h2><h3 id="1）优惠券表"><a href="#1）优惠券表" class="headerlink" title="1）优惠券表"></a>1）优惠券表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>coupon_id</td>
<td>bigint(50) NOT NULL</td>
<td>优惠券ID</td>
</tr>
<tr>
<td>coupon_price</td>
<td>decimal(10,2) NULL</td>
<td>优惠券金额</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint(50) NULL</td>
<td>用户ID</td>
</tr>
<tr>
<td>order_id</td>
<td>bigint(32) NULL</td>
<td>订单ID</td>
</tr>
<tr>
<td>is_used</td>
<td>int(1) NULL</td>
<td>是否使用 0未使用 1已使用</td>
</tr>
<tr>
<td>used_time</td>
<td>timestamp NULL</td>
<td>使用时间</td>
</tr>
</tbody></table>
<h3 id="2）商品表"><a href="#2）商品表" class="headerlink" title="2）商品表"></a>2）商品表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>goods_id</td>
<td>bigint(50) NOT NULL</td>
<td>主键</td>
</tr>
<tr>
<td>goods_name</td>
<td>varchar(255) NULL</td>
<td>商品名称</td>
</tr>
<tr>
<td>goods_number</td>
<td>int(11) NULL</td>
<td>商品库存</td>
</tr>
<tr>
<td>goods_price</td>
<td>decimal(10,2) NULL</td>
<td>商品价格</td>
</tr>
<tr>
<td>goods_desc</td>
<td>varchar(255) NULL</td>
<td>商品描述</td>
</tr>
<tr>
<td>add_time</td>
<td>timestamp NULL</td>
<td>添加时间</td>
</tr>
</tbody></table>
<h3 id="3）订单表"><a href="#3）订单表" class="headerlink" title="3）订单表"></a>3）订单表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>order_id</td>
<td>bigint(50) NOT NULL</td>
<td>订单ID</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint(50) NULL</td>
<td>用户ID</td>
</tr>
<tr>
<td>order_status</td>
<td>int(1) NULL</td>
<td>订单状态 0未确认 1已确认 2已取消 3无效 4退款</td>
</tr>
<tr>
<td>pay_status</td>
<td>int(1) NULL</td>
<td>支付状态 0未支付 1支付中 2已支付</td>
</tr>
<tr>
<td>shipping_status</td>
<td>int(1) NULL</td>
<td>发货状态 0未发货 1已发货 2已退货</td>
</tr>
<tr>
<td>address</td>
<td>varchar(255) NULL</td>
<td>收货地址</td>
</tr>
<tr>
<td>consignee</td>
<td>varchar(255) NULL</td>
<td>收货人</td>
</tr>
<tr>
<td>goods_id</td>
<td>bigint(50) NULL</td>
<td>商品ID</td>
</tr>
<tr>
<td>goods_number</td>
<td>int(11) NULL</td>
<td>商品数量</td>
</tr>
<tr>
<td>goods_price</td>
<td>decimal(10,2) NULL</td>
<td>商品价格</td>
</tr>
<tr>
<td>goods_amount</td>
<td>decimal(10,0) NULL</td>
<td>商品总价</td>
</tr>
<tr>
<td>shipping_fee</td>
<td>decimal(10,2) NULL</td>
<td>运费</td>
</tr>
<tr>
<td>order_amount</td>
<td>decimal(10,2) NULL</td>
<td>订单价格</td>
</tr>
<tr>
<td>coupon_id</td>
<td>bigint(50) NULL</td>
<td>优惠券ID</td>
</tr>
<tr>
<td>coupon_paid</td>
<td>decimal(10,2) NULL</td>
<td>优惠券</td>
</tr>
<tr>
<td>money_paid</td>
<td>decimal(10,2) NULL</td>
<td>已付金额</td>
</tr>
<tr>
<td>pay_amount</td>
<td>decimal(10,2) NULL</td>
<td>支付金额</td>
</tr>
<tr>
<td>add_time</td>
<td>timestamp NULL</td>
<td>创建时间</td>
</tr>
<tr>
<td>confirm_time</td>
<td>timestamp NULL</td>
<td>订单确认时间</td>
</tr>
<tr>
<td>pay_time</td>
<td>timestamp NULL</td>
<td>支付时间</td>
</tr>
</tbody></table>
<h3 id="4）订单商品日志表"><a href="#4）订单商品日志表" class="headerlink" title="4）订单商品日志表"></a>4）订单商品日志表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>goods_id</td>
<td>int(11) NOT NULL</td>
<td>商品ID</td>
</tr>
<tr>
<td>order_id</td>
<td>varchar(32) NOT NULL</td>
<td>订单ID</td>
</tr>
<tr>
<td>goods_number</td>
<td>int(11) NULL</td>
<td>库存数量</td>
</tr>
<tr>
<td>log_time</td>
<td>datetime NULL</td>
<td>记录时间</td>
</tr>
</tbody></table>
<h3 id="5）用户表"><a href="#5）用户表" class="headerlink" title="5）用户表"></a>5）用户表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>bigint(50) NOT NULL</td>
<td>用户ID</td>
</tr>
<tr>
<td>user_name</td>
<td>varchar(255) NULL</td>
<td>用户姓名</td>
</tr>
<tr>
<td>user_password</td>
<td>varchar(255) NULL</td>
<td>用户密码</td>
</tr>
<tr>
<td>user_mobile</td>
<td>varchar(255) NULL</td>
<td>手机号</td>
</tr>
<tr>
<td>user_score</td>
<td>int(11) NULL</td>
<td>积分</td>
</tr>
<tr>
<td>user_reg_time</td>
<td>timestamp NULL</td>
<td>注册时间</td>
</tr>
<tr>
<td>user_money</td>
<td>decimal(10,0) NULL</td>
<td>用户余额</td>
</tr>
</tbody></table>
<h3 id="6）用户余额日志表"><a href="#6）用户余额日志表" class="headerlink" title="6）用户余额日志表"></a>6）用户余额日志表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>bigint(50) NOT NULL</td>
<td>用户ID</td>
</tr>
<tr>
<td>order_id</td>
<td>bigint(50) NOT NULL</td>
<td>订单ID</td>
</tr>
<tr>
<td>money_log_type</td>
<td>int(1) NOT NULL</td>
<td>日志类型 1订单付款 2 订单退款</td>
</tr>
<tr>
<td>use_money</td>
<td>decimal(10,2) NULL</td>
<td>操作金额</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp NULL</td>
<td>日志时间</td>
</tr>
</tbody></table>
<h3 id="7）订单支付表"><a href="#7）订单支付表" class="headerlink" title="7）订单支付表"></a>7）订单支付表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>pay_id</td>
<td>bigint(50) NOT NULL</td>
<td>支付编号</td>
</tr>
<tr>
<td>order_id</td>
<td>bigint(50) NULL</td>
<td>订单编号</td>
</tr>
<tr>
<td>pay_amount</td>
<td>decimal(10,2) NULL</td>
<td>支付金额</td>
</tr>
<tr>
<td>is_paid</td>
<td>int(1) NULL</td>
<td>是否已支付 1否 2是</td>
</tr>
</tbody></table>
<h3 id="8）MQ消息生产表"><a href="#8）MQ消息生产表" class="headerlink" title="8）MQ消息生产表"></a>8）MQ消息生产表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar(100) NOT NULL</td>
<td>主键</td>
</tr>
<tr>
<td>group_name</td>
<td>varchar(100) NULL</td>
<td>生产者组名</td>
</tr>
<tr>
<td>msg_topic</td>
<td>varchar(100) NULL</td>
<td>消息主题</td>
</tr>
<tr>
<td>msg_tag</td>
<td>varchar(100) NULL</td>
<td>Tag</td>
</tr>
<tr>
<td>msg_key</td>
<td>varchar(100) NULL</td>
<td>Key</td>
</tr>
<tr>
<td>msg_body</td>
<td>varchar(500) NULL</td>
<td>消息内容</td>
</tr>
<tr>
<td>msg_status</td>
<td>int(1) NULL</td>
<td>0:未处理;1:已经处理</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp NOT NULL</td>
<td>记录时间</td>
</tr>
</tbody></table>
<h3 id="9）MQ消息消费表"><a href="#9）MQ消息消费表" class="headerlink" title="9）MQ消息消费表"></a>9）MQ消息消费表</h3><table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Comment</th>
</tr>
</thead>
<tbody><tr>
<td>msg_id</td>
<td>varchar(50) NULL</td>
<td>消息ID</td>
</tr>
<tr>
<td>group_name</td>
<td>varchar(100) NOT NULL</td>
<td>消费者组名</td>
</tr>
<tr>
<td>msg_tag</td>
<td>varchar(100) NOT NULL</td>
<td>Tag</td>
</tr>
<tr>
<td>msg_key</td>
<td>varchar(100) NOT NULL</td>
<td>Key</td>
</tr>
<tr>
<td>msg_body</td>
<td>varchar(500) NULL</td>
<td>消息体</td>
</tr>
<tr>
<td>consumer_status</td>
<td>int(1) NULL</td>
<td>0:正在处理;1:处理成功;2:处理失败</td>
</tr>
<tr>
<td>consumer_times</td>
<td>int(1) NULL</td>
<td>消费次数</td>
</tr>
<tr>
<td>consumer_timestamp</td>
<td>timestamp NULL</td>
<td>消费时间</td>
</tr>
<tr>
<td>remark</td>
<td>varchar(500) NULL</td>
<td>备注</td>
</tr>
</tbody></table>
<p>sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SQLyog Ultimate v8.32 </span></span><br><span class="line"><span class="comment">MySQL - 5.5.49 : Database - trade</span></span><br><span class="line"><span class="comment">*********************************************************************</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET NAMES utf8 */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET SQL_MODE=''*/</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */</span>;</span><br><span class="line"><span class="comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="comment">/*!32312 IF NOT EXISTS*/</span><span class="string">`trade`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> <span class="string">`trade`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_coupon` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_coupon`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_coupon`</span> (</span><br><span class="line">  <span class="string">`coupon_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'优惠券ID'</span>,</span><br><span class="line">  <span class="string">`coupon_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'优惠券金额'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单ID'</span>,</span><br><span class="line">  <span class="string">`is_used`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'是否使用 0未使用 1已使用'</span>,</span><br><span class="line">  <span class="string">`used_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'使用时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`coupon_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_coupon`</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_coupon2`</span> (<span class="string">`order_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_coupon` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_coupon`</span>(<span class="string">`coupon_id`</span>,<span class="string">`coupon_price`</span>,<span class="string">`user_id`</span>,<span class="string">`order_id`</span>,<span class="string">`is_used`</span>,<span class="string">`used_time`</span>) <span class="keyword">values</span> (<span class="number">345988230098857984</span>,<span class="string">'20.00'</span>,<span class="number">345963634385633280</span>,<span class="number">352537369385242624</span>,<span class="number">1</span>,<span class="string">'2019-07-27 16:58:44'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_goods` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_goods`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_goods`</span> (</span><br><span class="line">  <span class="string">`goods_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`goods_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">  <span class="string">`goods_number`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品库存'</span>,</span><br><span class="line">  <span class="string">`goods_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品价格'</span>,</span><br><span class="line">  <span class="string">`goods_desc`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品描述'</span>,</span><br><span class="line">  <span class="string">`add_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'添加时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`goods_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">345959443973935105</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_goods` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_goods`</span>(<span class="string">`goods_id`</span>,<span class="string">`goods_name`</span>,<span class="string">`goods_number`</span>,<span class="string">`goods_price`</span>,<span class="string">`goods_desc`</span>,<span class="string">`add_time`</span>) <span class="keyword">values</span> (<span class="number">345959443973935104</span>,<span class="string">'Javase课程'</span>,<span class="number">999</span>,<span class="string">'1000.00'</span>,<span class="string">'传智播客出品Java视频课程'</span>,<span class="string">'2019-07-09 20:38:00'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_goods_number_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_goods_number_log`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_goods_number_log`</span> (</span><br><span class="line">  <span class="string">`goods_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单ID'</span>,</span><br><span class="line">  <span class="string">`goods_number`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'库存数量'</span>,</span><br><span class="line">  <span class="string">`log_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`goods_id`</span>,<span class="string">`order_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_goods_number_log2`</span> (<span class="string">`order_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_goods_number_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_goods_number_log`</span>(<span class="string">`goods_id`</span>,<span class="string">`order_id`</span>,<span class="string">`goods_number`</span>,<span class="string">`log_time`</span>) <span class="keyword">values</span> (<span class="number">345959443973935104</span>,<span class="number">352537369385242624</span>,<span class="number">-1</span>,<span class="string">'2019-07-27 16:58:44'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_mq_consumer_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_mq_consumer_log`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_mq_consumer_log`</span> (</span><br><span class="line">  <span class="string">`msg_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_tag`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_key`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_body`</span> <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`consumer_status`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0:正在处理;1:处理成功;2:处理失败'</span>,</span><br><span class="line">  <span class="string">`consumer_times`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`consumer_timestamp`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`remark`</span> <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`group_name`</span>,<span class="string">`msg_tag`</span>,<span class="string">`msg_key`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_mq_consumer_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_mq_producer_temp` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_mq_producer_temp`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_mq_producer_temp`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`group_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_topic`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_tag`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_key`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_body`</span> <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`msg_status`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0:未处理;1:已经处理'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_mq_producer_temp` */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_order` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_order`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_order`</span> (</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`order_status`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单状态 0未确认 1已确认 2已取消 3无效 4退款'</span>,</span><br><span class="line">  <span class="string">`pay_status`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付状态 0未支付 1支付中 2已支付'</span>,</span><br><span class="line">  <span class="string">`shipping_status`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'发货状态 0未发货 1已发货 2已收货'</span>,</span><br><span class="line">  <span class="string">`address`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货地址'</span>,</span><br><span class="line">  <span class="string">`consignee`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货人'</span>,</span><br><span class="line">  <span class="string">`goods_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line">  <span class="string">`goods_number`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品数量'</span>,</span><br><span class="line">  <span class="string">`goods_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品价格'</span>,</span><br><span class="line">  <span class="string">`goods_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品总价'</span>,</span><br><span class="line">  <span class="string">`shipping_fee`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'运费'</span>,</span><br><span class="line">  <span class="string">`order_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单价格'</span>,</span><br><span class="line">  <span class="string">`coupon_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'优惠券ID'</span>,</span><br><span class="line">  <span class="string">`coupon_paid`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'优惠券'</span>,</span><br><span class="line">  <span class="string">`money_paid`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'已付金额'</span>,</span><br><span class="line">  <span class="string">`pay_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付金额'</span>,</span><br><span class="line">  <span class="string">`add_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`confirm_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单确认时间'</span>,</span><br><span class="line">  <span class="string">`pay_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`order_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_order`</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_order2`</span> (<span class="string">`goods_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_order3`</span> (<span class="string">`coupon_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_order` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_order`</span>(<span class="string">`order_id`</span>,<span class="string">`user_id`</span>,<span class="string">`order_status`</span>,<span class="string">`pay_status`</span>,<span class="string">`shipping_status`</span>,<span class="string">`address`</span>,<span class="string">`consignee`</span>,<span class="string">`goods_id`</span>,<span class="string">`goods_number`</span>,<span class="string">`goods_price`</span>,<span class="string">`goods_amount`</span>,<span class="string">`shipping_fee`</span>,<span class="string">`order_amount`</span>,<span class="string">`coupon_id`</span>,<span class="string">`coupon_paid`</span>,<span class="string">`money_paid`</span>,<span class="string">`pay_amount`</span>,<span class="string">`add_time`</span>,<span class="string">`confirm_time`</span>,<span class="string">`pay_time`</span>) <span class="keyword">values</span> (<span class="number">352537369385242624</span>,<span class="number">345963634385633280</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="literal">NULL</span>,<span class="string">'北京'</span>,<span class="literal">NULL</span>,<span class="number">345959443973935104</span>,<span class="number">1</span>,<span class="string">'1000.00'</span>,<span class="literal">NULL</span>,<span class="string">'0.00'</span>,<span class="string">'1000.00'</span>,<span class="number">345988230098857984</span>,<span class="string">'20.00'</span>,<span class="string">'100.00'</span>,<span class="string">'880.00'</span>,<span class="string">'2019-07-27 16:58:44'</span>,<span class="string">'2019-07-27 16:58:44'</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_pay` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_pay`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_pay`</span> (</span><br><span class="line">  <span class="string">`pay_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付编号'</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单编号'</span>,</span><br><span class="line">  <span class="string">`pay_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付金额'</span>,</span><br><span class="line">  <span class="string">`is_paid`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'是否已支付 0:未付款 1正在付款 2已经付款'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`pay_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_pay`</span> (<span class="string">`order_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_pay` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_pay`</span>(<span class="string">`pay_id`</span>,<span class="string">`order_id`</span>,<span class="string">`pay_amount`</span>,<span class="string">`is_paid`</span>) <span class="keyword">values</span> (<span class="number">352542415984402432</span>,<span class="number">352537369385242624</span>,<span class="string">'880.00'</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_user` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_user`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_user`</span> (</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户姓名'</span>,</span><br><span class="line">  <span class="string">`user_password`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户密码'</span>,</span><br><span class="line">  <span class="string">`user_mobile`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'手机号'</span>,</span><br><span class="line">  <span class="string">`user_score`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'积分'</span>,</span><br><span class="line">  <span class="string">`user_reg_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'注册时间'</span>,</span><br><span class="line">  <span class="string">`user_money`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户余额'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">345963634385633281</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_user` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_user`</span>(<span class="string">`user_id`</span>,<span class="string">`user_name`</span>,<span class="string">`user_password`</span>,<span class="string">`user_mobile`</span>,<span class="string">`user_score`</span>,<span class="string">`user_reg_time`</span>,<span class="string">`user_money`</span>) <span class="keyword">values</span> (<span class="number">345963634385633280</span>,<span class="string">'zs'</span>,<span class="string">'123456'</span>,<span class="string">'18888888888'</span>,<span class="number">100</span>,<span class="string">'2020-10-10 00:00:00'</span>,<span class="string">'900'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `trade_user_money_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`trade_user_money_log`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_user_money_log`</span> (</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单ID'</span>,</span><br><span class="line">  <span class="string">`money_log_type`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日志类型 1订单付款 2 订单退款'</span>,</span><br><span class="line">  <span class="string">`use_money`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日志时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>,<span class="string">`order_id`</span>,<span class="string">`money_log_type`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`FK_trade_user_money_log2`</span> (<span class="string">`order_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `trade_user_money_log` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`trade_user_money_log`</span>(<span class="string">`user_id`</span>,<span class="string">`order_id`</span>,<span class="string">`money_log_type`</span>,<span class="string">`use_money`</span>,<span class="string">`create_time`</span>) <span class="keyword">values</span> (<span class="number">345963634385633280</span>,<span class="number">352537369385242624</span>,<span class="number">1</span>,<span class="string">'100.00'</span>,<span class="string">'2019-07-27 16:58:44'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span>;</span><br><span class="line"><span class="comment">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span>;</span><br></pre></td></tr></table></figure>



<h2 id="7-2-项目初始化"><a href="#7-2-项目初始化" class="headerlink" title="7.2 项目初始化"></a>7.2 项目初始化</h2><h3 id="7-2-1-工程概览"><a href="#7-2-1-工程概览" class="headerlink" title="7.2.1 工程概览"></a>7.2.1 工程概览</h3><p><img src="https://pic.imgdb.cn/item/5f0b237314195aa59431dc47.jpg" alt=""></p>
<h3 id="7-2-2-工程关系"><a href="#7-2-2-工程关系" class="headerlink" title="7.2.2 工程关系"></a>7.2.2 工程关系</h3><p><img src="https://pic.imgdb.cn/item/5f0b23ba14195aa59431f4a4.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f0b23d114195aa59431fcbb.jpg" alt=""></p>
<h2 id="7-3-Mybatis逆向工程使用"><a href="#7-3-Mybatis逆向工程使用" class="headerlink" title="7.3 Mybatis逆向工程使用"></a>7.3 Mybatis逆向工程使用</h2><p> 略</p>
<h2 id="7-4-公共类介绍"><a href="#7-4-公共类介绍" class="headerlink" title="7.4 公共类介绍"></a>7.4 公共类介绍</h2><ul>
<li><p>ID生成器</p>
<p>IDWorker:Twitter雪花算法</p>
</li>
<li><p>异常处理类</p>
<p>CustomerException：自定义异常类</p>
<p>CastException：异常抛出类</p>
</li>
<li><p>常量类</p>
<p>ShopCode：系统状态类</p>
</li>
<li><p>响应实体类</p>
<p>Result：封装响应状态</p>
</li>
</ul>
<h1 id="8下单业务"><a href="#8下单业务" class="headerlink" title="8下单业务"></a>8下单业务</h1><h2 id="8-1-下单基本流程"><a href="#8-1-下单基本流程" class="headerlink" title="8.1 下单基本流程"></a>8.1 下单基本流程</h2><p><img src="https://pic.imgdb.cn/item/5f0c69cd14195aa5948c60ab.jpg" alt=""></p>
<h3 id="1）接口定义"><a href="#1）接口定义" class="headerlink" title="1）接口定义"></a>1）接口定义</h3><ul>
<li>IOrderService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IOrderService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Result <span class="title">confirmOrder</span><span class="params">(TradeOrder order)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2）业务类实现"><a href="#2）业务类实现" class="headerlink" title="2）业务类实现"></a>2）业务类实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Service</span>(interfaceClass = IOrderService<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">IOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">confirmOrder</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.校验订单</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//2.生成预订单</span></span><br><span class="line">       </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//3.扣减库存</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4.扣减优惠券</span></span><br><span class="line">           </span><br><span class="line">            <span class="comment">//5.使用余额</span></span><br><span class="line">           </span><br><span class="line">            <span class="comment">//6.确认订单</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//7.返回成功状态</span></span><br><span class="line">           </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//1.确认订单失败,发送消息</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2.返回失败状态</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3）校验订单"><a href="#3）校验订单" class="headerlink" title="3）校验订单"></a>3）校验订单</h3><p><img src="https://pic.imgdb.cn/item/5f145ba414195aa594e34985.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145e6714195aa594e42def.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkOrder</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.校验订单是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(order==<span class="keyword">null</span>)&#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_ORDER_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.校验订单中的商品是否存在</span></span><br><span class="line">        TradeGoods goods = goodsService.findOne(order.getGoodsId());</span><br><span class="line">        <span class="keyword">if</span>(goods==<span class="keyword">null</span>)&#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_GOODS_NO_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.校验下单用户是否存在</span></span><br><span class="line">        TradeUser user = userService.findOne(order.getUserId());</span><br><span class="line">        <span class="keyword">if</span>(user==<span class="keyword">null</span>)&#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_USER_NO_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.校验商品单价是否合法</span></span><br><span class="line">        <span class="keyword">if</span>(order.getGoodsPrice().compareTo(goods.getGoodsPrice())!=<span class="number">0</span>)&#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_GOODS_PRICE_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5.校验订单商品数量是否合法</span></span><br><span class="line">        <span class="keyword">if</span>(order.getGoodsNumber()&gt;=goods.getGoodsNumber())&#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_GOODS_NUM_NOT_ENOUGH);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"校验订单通过"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4）生成预订单"><a href="#4）生成预订单" class="headerlink" title="4）生成预订单"></a>4）生成预订单</h3><p><img src="https://pic.imgdb.cn/item/5f145e9514195aa594e43d50.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145eb714195aa594e44914.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145eda14195aa594e45312.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Long <span class="title">savePreOrder</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.设置订单状态为不可见</span></span><br><span class="line">        order.setOrderStatus(ShopCode.SHOP_ORDER_NO_CONFIRM.getCode());</span><br><span class="line">        <span class="comment">//2.订单ID</span></span><br><span class="line">        order.setOrderId(idWorker.nextId());</span><br><span class="line">        <span class="comment">//核算运费是否正确</span></span><br><span class="line">        BigDecimal shippingFee = calculateShippingFee(order.getOrderAmount());</span><br><span class="line">        <span class="keyword">if</span> (order.getShippingFee().compareTo(shippingFee) != <span class="number">0</span>) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_ORDER_SHIPPINGFEE_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.计算订单总价格是否正确</span></span><br><span class="line">        BigDecimal orderAmount = order.getGoodsPrice().multiply(<span class="keyword">new</span> BigDecimal(order.getGoodsNumber()));</span><br><span class="line">        orderAmount.add(shippingFee);</span><br><span class="line">        <span class="keyword">if</span> (orderAmount.compareTo(order.getOrderAmount()) != <span class="number">0</span>) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_ORDERAMOUNT_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.判断优惠券信息是否合法</span></span><br><span class="line">        Long couponId = order.getCouponId();</span><br><span class="line">        <span class="keyword">if</span> (couponId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            TradeCoupon coupon = couponService.findOne(couponId);</span><br><span class="line">            <span class="comment">//优惠券不存在</span></span><br><span class="line">            <span class="keyword">if</span> (coupon == <span class="keyword">null</span>) &#123;</span><br><span class="line">                CastException.cast(ShopCode.SHOP_COUPON_NO_EXIST);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//优惠券已经使用</span></span><br><span class="line">            <span class="keyword">if</span> ((ShopCode.SHOP_COUPON_ISUSED.getCode().toString())</span><br><span class="line">                .equals(coupon.getIsUsed().toString())) &#123;</span><br><span class="line">                CastException.cast(ShopCode.SHOP_COUPON_INVALIED);</span><br><span class="line">            &#125;</span><br><span class="line">            order.setCouponPaid(coupon.getCouponPrice());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            order.setCouponPaid(BigDecimal.ZERO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.判断余额是否正确</span></span><br><span class="line">        BigDecimal moneyPaid = order.getMoneyPaid();</span><br><span class="line">        <span class="keyword">if</span> (moneyPaid != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//比较余额是否大于0</span></span><br><span class="line">            <span class="keyword">int</span> r = order.getMoneyPaid().compareTo(BigDecimal.ZERO);</span><br><span class="line">            <span class="comment">//余额小于0</span></span><br><span class="line">            <span class="keyword">if</span> (r == -<span class="number">1</span>) &#123;</span><br><span class="line">                CastException.cast(ShopCode.SHOP_MONEY_PAID_LESS_ZERO);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//余额大于0</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">//查询用户信息</span></span><br><span class="line">                TradeUser user = userService.findOne(order.getUserId());</span><br><span class="line">                <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    CastException.cast(ShopCode.SHOP_USER_NO_EXIST);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//比较余额是否大于用户账户余额</span></span><br><span class="line">            <span class="keyword">if</span> (user.getUserMoney().compareTo(order.getMoneyPaid().longValue()) == -<span class="number">1</span>) &#123;</span><br><span class="line">                CastException.cast(ShopCode.SHOP_MONEY_PAID_INVALID);</span><br><span class="line">            &#125;</span><br><span class="line">            order.setMoneyPaid(order.getMoneyPaid());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        order.setMoneyPaid(BigDecimal.ZERO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算订单支付总价</span></span><br><span class="line">    order.setPayAmount(orderAmount.subtract(order.getCouponPaid())</span><br><span class="line">                       .subtract(order.getMoneyPaid()));</span><br><span class="line">    <span class="comment">//设置订单添加时间</span></span><br><span class="line">    order.setAddTime(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存预订单</span></span><br><span class="line">    <span class="keyword">int</span> r = orderMapper.insert(order);</span><br><span class="line">    <span class="keyword">if</span> (ShopCode.SHOP_SUCCESS.getCode() != r) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_ORDER_SAVE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]预订单生成成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> order.getOrderId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5）扣减库存"><a href="#5）扣减库存" class="headerlink" title="5）扣减库存"></a>5）扣减库存</h3><ul>
<li>通过dubbo调用商品服务完成扣减库存</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reduceGoodsNum</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">        TradeGoodsNumberLog goodsNumberLog = <span class="keyword">new</span> TradeGoodsNumberLog();</span><br><span class="line">        goodsNumberLog.setGoodsId(order.getGoodsId());</span><br><span class="line">        goodsNumberLog.setOrderId(order.getOrderId());</span><br><span class="line">        goodsNumberLog.setGoodsNumber(order.getGoodsNumber());</span><br><span class="line">        Result result = goodsService.reduceGoodsNum(goodsNumberLog);</span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess().equals(ShopCode.SHOP_FAIL.getSuccess())) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_REDUCE_GOODS_NUM_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]扣减库存["</span>+order.getGoodsNumber()+<span class="string">"个]成功"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>商品服务GoodsService扣减库存</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">reduceGoodsNum</span><span class="params">(TradeGoodsNumberLog goodsNumberLog)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (goodsNumberLog == <span class="keyword">null</span> ||</span><br><span class="line">            goodsNumberLog.getGoodsNumber() == <span class="keyword">null</span> ||</span><br><span class="line">            goodsNumberLog.getOrderId() == <span class="keyword">null</span> ||</span><br><span class="line">            goodsNumberLog.getGoodsNumber() == <span class="keyword">null</span> ||</span><br><span class="line">            goodsNumberLog.getGoodsNumber().intValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_VALID);</span><br><span class="line">    &#125;</span><br><span class="line">    TradeGoods goods = goodsMapper.selectByPrimaryKey(goodsNumberLog.getGoodsId());</span><br><span class="line">    <span class="keyword">if</span>(goods.getGoodsNumber()&lt;goodsNumberLog.getGoodsNumber())&#123;</span><br><span class="line">        <span class="comment">//库存不足</span></span><br><span class="line">        CastException.cast(ShopCode.SHOP_GOODS_NUM_NOT_ENOUGH);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减库存</span></span><br><span class="line">    goods.setGoodsNumber(goods.getGoodsNumber()-goodsNumberLog.getGoodsNumber());</span><br><span class="line">    goodsMapper.updateByPrimaryKey(goods);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录库存操作日志</span></span><br><span class="line">    goodsNumberLog.setGoodsNumber(-(goodsNumberLog.getGoodsNumber()));</span><br><span class="line">    goodsNumberLog.setLogTime(<span class="keyword">new</span> Date());</span><br><span class="line">    goodsNumberLogMapper.insert(goodsNumberLog);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6）扣减优惠券"><a href="#6）扣减优惠券" class="headerlink" title="6）扣减优惠券"></a>6）扣减优惠券</h3><ul>
<li>通过dubbo完成扣减优惠券</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">changeCoponStatus</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断用户是否使用优惠券</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(order.getCouponId())) &#123;</span><br><span class="line">        <span class="comment">//封装优惠券对象</span></span><br><span class="line">        TradeCoupon coupon = couponService.findOne(order.getCouponId());</span><br><span class="line">        coupon.setIsUsed(ShopCode.SHOP_COUPON_ISUSED.getCode());</span><br><span class="line">        coupon.setUsedTime(<span class="keyword">new</span> Date());</span><br><span class="line">        coupon.setOrderId(order.getOrderId());</span><br><span class="line">        Result result = couponService.changeCouponStatus(coupon);</span><br><span class="line">        <span class="comment">//判断执行结果</span></span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess().equals(ShopCode.SHOP_FAIL.getSuccess())) &#123;</span><br><span class="line">            <span class="comment">//优惠券使用失败</span></span><br><span class="line">            CastException.cast(ShopCode.SHOP_COUPON_USE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]使用扣减优惠券["</span>+coupon.getCouponPrice()+<span class="string">"元]成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>优惠券服务CouponService更改优惠券状态</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">changeCouponStatus</span><span class="params">(TradeCoupon coupon)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//判断请求参数是否合法</span></span><br><span class="line">        <span class="keyword">if</span> (coupon == <span class="keyword">null</span> || StringUtils.isEmpty(coupon.getCouponId())) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_VALID);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//更新优惠券状态为已使用</span></span><br><span class="line">        couponMapper.updateByPrimaryKey(coupon);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(), ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_FAIL.getSuccess(), ShopCode.SHOP_FAIL.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7）扣减用户余额"><a href="#7）扣减用户余额" class="headerlink" title="7）扣减用户余额"></a>7）扣减用户余额</h3><ul>
<li>通过用户服务完成扣减余额</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reduceMoneyPaid</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断订单中使用的余额是否合法</span></span><br><span class="line">    <span class="keyword">if</span> (order.getMoneyPaid() != <span class="keyword">null</span> &amp;&amp; order.getMoneyPaid().compareTo(BigDecimal.ZERO) == <span class="number">1</span>) &#123;</span><br><span class="line">        TradeUserMoneyLog userMoneyLog = <span class="keyword">new</span> TradeUserMoneyLog();</span><br><span class="line">        userMoneyLog.setOrderId(order.getOrderId());</span><br><span class="line">        userMoneyLog.setUserId(order.getUserId());</span><br><span class="line">        userMoneyLog.setUseMoney(order.getMoneyPaid());</span><br><span class="line">        userMoneyLog.setMoneyLogType(ShopCode.SHOP_USER_MONEY_PAID.getCode());</span><br><span class="line">        <span class="comment">//扣减余额</span></span><br><span class="line">        Result result = userService.changeUserMoney(userMoneyLog);</span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess().equals(ShopCode.SHOP_FAIL.getSuccess())) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_USER_MONEY_REDUCE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"扣减余额["</span>+order.getMoneyPaid()+<span class="string">"元]成功]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用户服务UserService,更新余额</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/5f145cd614195aa594e3a838.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145cb614195aa594e39d7b.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">changeUserMoney</span><span class="params">(TradeUserMoneyLog userMoneyLog)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断请求参数是否合法</span></span><br><span class="line">    <span class="keyword">if</span> (userMoneyLog == <span class="keyword">null</span></span><br><span class="line">            || userMoneyLog.getUserId() == <span class="keyword">null</span></span><br><span class="line">            || userMoneyLog.getUseMoney() == <span class="keyword">null</span></span><br><span class="line">            || userMoneyLog.getOrderId() == <span class="keyword">null</span></span><br><span class="line">            || userMoneyLog.getUseMoney().compareTo(BigDecimal.ZERO) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_VALID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询该订单是否存在付款记录</span></span><br><span class="line">    TradeUserMoneyLogExample userMoneyLogExample = <span class="keyword">new</span> TradeUserMoneyLogExample();</span><br><span class="line">    userMoneyLogExample.createCriteria()</span><br><span class="line">            .andUserIdEqualTo(userMoneyLog.getUserId())</span><br><span class="line">            .andOrderIdEqualTo(userMoneyLog.getOrderId());</span><br><span class="line">   <span class="keyword">int</span> count = userMoneyLogMapper.countByExample(userMoneyLogExample);</span><br><span class="line">   TradeUser tradeUser = <span class="keyword">new</span> TradeUser();</span><br><span class="line">   tradeUser.setUserId(userMoneyLog.getUserId());</span><br><span class="line">   tradeUser.setUserMoney(userMoneyLog.getUseMoney().longValue());</span><br><span class="line">   <span class="comment">//判断余额操作行为</span></span><br><span class="line">   <span class="comment">//【付款操作】</span></span><br><span class="line">   <span class="keyword">if</span> (userMoneyLog.getMoneyLogType().equals(ShopCode.SHOP_USER_MONEY_PAID.getCode())) &#123;</span><br><span class="line">           <span class="comment">//订单已经付款，则抛异常</span></span><br><span class="line">           <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                CastException.cast(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY);</span><br><span class="line">            &#125;</span><br><span class="line">       	   <span class="comment">//用户账户扣减余额</span></span><br><span class="line">           userMapper.reduceUserMoney(tradeUser);</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="comment">//【退款操作】</span></span><br><span class="line">    <span class="keyword">if</span> (userMoneyLog.getMoneyLogType().equals(ShopCode.SHOP_USER_MONEY_REFUND.getCode())) &#123;</span><br><span class="line">         <span class="comment">//如果订单未付款,则不能退款,抛异常</span></span><br><span class="line">         <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">         CastException.cast(ShopCode.SHOP_ORDER_PAY_STATUS_NO_PAY);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//防止多次退款</span></span><br><span class="line">     userMoneyLogExample = <span class="keyword">new</span> TradeUserMoneyLogExample();</span><br><span class="line">     userMoneyLogExample.createCriteria()</span><br><span class="line">             .andUserIdEqualTo(userMoneyLog.getUserId())</span><br><span class="line">                .andOrderIdEqualTo(userMoneyLog.getOrderId())</span><br><span class="line">                .andMoneyLogTypeEqualTo(ShopCode.SHOP_USER_MONEY_REFUND.getCode());</span><br><span class="line">     count = userMoneyLogMapper.countByExample(userMoneyLogExample);</span><br><span class="line">     <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         CastException.cast(ShopCode.SHOP_USER_MONEY_REFUND_ALREADY);</span><br><span class="line">     &#125;</span><br><span class="line">     	<span class="comment">//用户账户添加余额</span></span><br><span class="line">        userMapper.addUserMoney(tradeUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录用户使用余额日志</span></span><br><span class="line">    userMoneyLog.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    userMoneyLogMapper.insert(userMoneyLog);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8）确认订单"><a href="#8）确认订单" class="headerlink" title="8）确认订单"></a>8）确认订单</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateOrderStatus</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">    order.setOrderStatus(ShopCode.SHOP_ORDER_CONFIRM.getCode());</span><br><span class="line">    order.setPayStatus(ShopCode.SHOP_ORDER_PAY_STATUS_NO_PAY.getCode());</span><br><span class="line">    order.setConfirmTime(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">int</span> r = orderMapper.updateByPrimaryKey(order);</span><br><span class="line">    <span class="keyword">if</span> (r &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_ORDER_CONFIRM_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]状态修改成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9）小结"><a href="#9）小结" class="headerlink" title="9）小结"></a>9）小结</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">confirmOrder</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.校验订单</span></span><br><span class="line">    checkOrder(order);</span><br><span class="line">    <span class="comment">//2.生成预订单</span></span><br><span class="line">    Long orderId = savePreOrder(order);</span><br><span class="line">    order.setOrderId(orderId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//3.扣减库存</span></span><br><span class="line">        reduceGoodsNum(order);</span><br><span class="line">        <span class="comment">//4.扣减优惠券</span></span><br><span class="line">        changeCoponStatus(order);</span><br><span class="line">        <span class="comment">//5.使用余额</span></span><br><span class="line">        reduceMoneyPaid(order);</span><br><span class="line">        <span class="comment">//6.确认订单</span></span><br><span class="line">        updateOrderStatus(order);</span><br><span class="line">        log.info(<span class="string">"订单:["</span>+orderId+<span class="string">"]确认成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(), ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//确认订单失败,发送消息</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_FAIL.getSuccess(), ShopCode.SHOP_FAIL.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-2-失败补偿机制"><a href="#8-2-失败补偿机制" class="headerlink" title="8.2 失败补偿机制"></a>8.2 失败补偿机制</h2><h3 id="8-2-1-消息发送方"><a href="#8-2-1-消息发送方" class="headerlink" title="8.2.1 消息发送方"></a>8.2.1 消息发送方</h3><ul>
<li>配置RocketMQ属性值</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">rocketmq.name-server</span>=<span class="string">192.168.25.135:9876;192.168.25.138:9876</span></span><br><span class="line"><span class="meta">rocketmq.producer.group</span>=<span class="string">orderProducerGroup</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mq.order.consumer.group.name</span>=<span class="string">order_orderTopic_cancel_group</span></span><br><span class="line"><span class="meta">mq.order.topic</span>=<span class="string">orderTopic</span></span><br><span class="line"><span class="meta">mq.order.tag.confirm</span>=<span class="string">order_confirm</span></span><br><span class="line"><span class="meta">mq.order.tag.cancel</span>=<span class="string">order_cancel</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注入模板类和属性值信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;mq.order.topic&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;mq.order.tag.cancel&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String cancelTag;</span><br></pre></td></tr></table></figure>

<ul>
<li>发送下单失败消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">confirmOrder</span><span class="params">(TradeOrder order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.校验订单</span></span><br><span class="line">    <span class="comment">//2.生成预订</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//3.扣减库存</span></span><br><span class="line">        <span class="comment">//4.扣减优惠券</span></span><br><span class="line">        <span class="comment">//5.使用余额</span></span><br><span class="line">        <span class="comment">//6.确认订单</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//确认订单失败,发送消息</span></span><br><span class="line">        CancelOrderMQ cancelOrderMQ = <span class="keyword">new</span> CancelOrderMQ();</span><br><span class="line">        cancelOrderMQ.setOrderId(order.getOrderId());</span><br><span class="line">        cancelOrderMQ.setCouponId(order.getCouponId());</span><br><span class="line">        cancelOrderMQ.setGoodsId(order.getGoodsId());</span><br><span class="line">        cancelOrderMQ.setGoodsNumber(order.getGoodsNumber());</span><br><span class="line">        cancelOrderMQ.setUserId(order.getUserId());</span><br><span class="line">        cancelOrderMQ.setUserMoney(order.getMoneyPaid());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sendMessage(topic, </span><br><span class="line">                        cancelTag, </span><br><span class="line">                        cancelOrderMQ.getOrderId().toString(), </span><br><span class="line">                    JSON.toJSONString(cancelOrderMQ));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">        e1.printStackTrace();</span><br><span class="line">            CastException.cast(ShopCode.SHOP_MQ_SEND_MESSAGE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_FAIL.getSuccess(), ShopCode.SHOP_FAIL.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String topic, String tags, String keys, String body)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//判断Topic是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(topic)) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_MQ_TOPIC_IS_EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断消息内容是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(body)) &#123;</span><br><span class="line">        CastException.cast(ShopCode.SHOP_MQ_MESSAGE_BODY_IS_EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//消息体</span></span><br><span class="line">    Message message = <span class="keyword">new</span> Message(topic, tags, keys, body.getBytes());</span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    rocketMQTemplate.getProducer().send(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-2-消费接收方"><a href="#8-2-2-消费接收方" class="headerlink" title="8.2.2 消费接收方"></a>8.2.2 消费接收方</h3><ul>
<li>配置RocketMQ属性值</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">rocketmq.name-server</span>=<span class="string">192.168.25.135:9876;192.168.25.138:9876</span></span><br><span class="line"><span class="meta">mq.order.consumer.group.name</span>=<span class="string">order_orderTopic_cancel_group</span></span><br><span class="line"><span class="meta">mq.order.topic</span>=<span class="string">orderTopic</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建监听类，消费消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"$&#123;mq.order.topic&#125;"</span>, </span><br><span class="line">                         consumerGroup = <span class="string">"$&#123;mq.order.consumer.group.name&#125;"</span>,</span><br><span class="line">                         messageModel = MessageModel.BROADCASTING)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CancelOrderConsumer</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">MessageExt</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1）回退库存"><a href="#1）回退库存" class="headerlink" title="1）回退库存"></a>1）回退库存</h4><ul>
<li>流程分析</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/5f145d0b14195aa594e3b848.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145d5f14195aa594e3d3b8.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145d4c14195aa594e3ce57.jpg" alt=""></p>
<ul>
<li>消息消费者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"$&#123;mq.order.topic&#125;"</span>,consumerGroup = <span class="string">"$&#123;mq.order.consumer.group.name&#125;"</span>,messageModel = MessageModel.BROADCASTING )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CancelMQListener</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">MessageExt</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.order.consumer.group.name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TradeGoodsMapper goodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TradeMqConsumerLogMapper mqConsumerLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TradeGoodsNumberLogMapper goodsNumberLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">        String msgId=<span class="keyword">null</span>;</span><br><span class="line">        String tags=<span class="keyword">null</span>;</span><br><span class="line">        String keys=<span class="keyword">null</span>;</span><br><span class="line">        String body=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 解析消息内容</span></span><br><span class="line">            msgId = messageExt.getMsgId();</span><br><span class="line">            tags= messageExt.getTags();</span><br><span class="line">            keys= messageExt.getKeys();</span><br><span class="line">            body= <span class="keyword">new</span> String(messageExt.getBody(),<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">"接受消息成功"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 查询消息消费记录</span></span><br><span class="line">            TradeMqConsumerLogKey primaryKey = <span class="keyword">new</span> TradeMqConsumerLogKey();</span><br><span class="line">            primaryKey.setMsgTag(tags);</span><br><span class="line">            primaryKey.setMsgKey(keys);</span><br><span class="line">            primaryKey.setGroupName(groupName);</span><br><span class="line">            TradeMqConsumerLog mqConsumerLog = mqConsumerLogMapper.selectByPrimaryKey(primaryKey);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(mqConsumerLog!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//3. 判断如果消费过...</span></span><br><span class="line">                <span class="comment">//3.1 获得消息处理状态</span></span><br><span class="line">                Integer status = mqConsumerLog.getConsumerStatus();</span><br><span class="line">                <span class="comment">//处理过...返回</span></span><br><span class="line">                <span class="keyword">if</span>(ShopCode.SHOP_MQ_MESSAGE_STATUS_SUCCESS.getCode().intValue()==status.intValue())&#123;</span><br><span class="line">                    log.info(<span class="string">"消息:"</span>+msgId+<span class="string">",已经处理过"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//正在处理...返回</span></span><br><span class="line">                <span class="keyword">if</span>(ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode().intValue()==status.intValue())&#123;</span><br><span class="line">                    log.info(<span class="string">"消息:"</span>+msgId+<span class="string">",正在处理"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//处理失败</span></span><br><span class="line">                <span class="keyword">if</span>(ShopCode.SHOP_MQ_MESSAGE_STATUS_FAIL.getCode().intValue()==status.intValue())&#123;</span><br><span class="line">                    <span class="comment">//获得消息处理次数</span></span><br><span class="line">                    Integer times = mqConsumerLog.getConsumerTimes();</span><br><span class="line">                    <span class="keyword">if</span>(times&gt;<span class="number">3</span>)&#123;</span><br><span class="line">                        log.info(<span class="string">"消息:"</span>+msgId+<span class="string">",消息处理超过3次,不能再进行处理了"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//使用数据库乐观锁更新</span></span><br><span class="line">                    TradeMqConsumerLogExample example = <span class="keyword">new</span> TradeMqConsumerLogExample();</span><br><span class="line">                    TradeMqConsumerLogExample.Criteria criteria = example.createCriteria();</span><br><span class="line">                    criteria.andMsgTagEqualTo(mqConsumerLog.getMsgTag());</span><br><span class="line">                    criteria.andMsgKeyEqualTo(mqConsumerLog.getMsgKey());</span><br><span class="line">                    criteria.andGroupNameEqualTo(groupName);</span><br><span class="line">                    criteria.andConsumerTimesEqualTo(mqConsumerLog.getConsumerTimes());</span><br><span class="line">                    <span class="keyword">int</span> r = mqConsumerLogMapper.updateByExampleSelective(mqConsumerLog, example);</span><br><span class="line">                    <span class="keyword">if</span>(r&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">//未修改成功,其他线程并发修改</span></span><br><span class="line">                        log.info(<span class="string">"并发修改,稍后处理"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//4. 判断如果没有消费过...</span></span><br><span class="line">                mqConsumerLog = <span class="keyword">new</span> TradeMqConsumerLog();</span><br><span class="line">                mqConsumerLog.setMsgTag(tags);</span><br><span class="line">                mqConsumerLog.setMsgKey(keys);</span><br><span class="line">                mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode());</span><br><span class="line">                mqConsumerLog.setMsgBody(body);</span><br><span class="line">                mqConsumerLog.setMsgId(msgId);</span><br><span class="line">                mqConsumerLog.setConsumerTimes(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将消息处理信息添加到数据库</span></span><br><span class="line">                mqConsumerLogMapper.insert(mqConsumerLog);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5. 回退库存</span></span><br><span class="line">            MQEntity mqEntity = JSON.parseObject(body, MQEntity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            Long goodsId = mqEntity.getGoodsId();</span><br><span class="line">            TradeGoods goods = goodsMapper.selectByPrimaryKey(goodsId);</span><br><span class="line">            goods.setGoodsNumber(goods.getGoodsNumber()+mqEntity.getGoodsNum());</span><br><span class="line">            goodsMapper.updateByPrimaryKey(goods);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//记录库存操作日志</span></span><br><span class="line">            TradeGoodsNumberLog goodsNumberLog = <span class="keyword">new</span> TradeGoodsNumberLog();</span><br><span class="line">            goodsNumberLog.setOrderId(mqEntity.getOrderId());</span><br><span class="line">            goodsNumberLog.setGoodsId(goodsId);</span><br><span class="line">            goodsNumberLog.setGoodsNumber(mqEntity.getGoodsNum());</span><br><span class="line">            goodsNumberLog.setLogTime(<span class="keyword">new</span> Date());</span><br><span class="line">            goodsNumberLogMapper.insert(goodsNumberLog);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//6. 将消息的处理状态改为成功</span></span><br><span class="line">            mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_SUCCESS.getCode());</span><br><span class="line">            mqConsumerLog.setConsumerTimestamp(<span class="keyword">new</span> Date());</span><br><span class="line">            mqConsumerLogMapper.updateByPrimaryKey(mqConsumerLog);</span><br><span class="line">            log.info(<span class="string">"回退库存成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            TradeMqConsumerLogKey primaryKey = <span class="keyword">new</span> TradeMqConsumerLogKey();</span><br><span class="line">            primaryKey.setMsgTag(tags);</span><br><span class="line">            primaryKey.setMsgKey(keys);</span><br><span class="line">            primaryKey.setGroupName(groupName);</span><br><span class="line">            TradeMqConsumerLog mqConsumerLog = mqConsumerLogMapper.selectByPrimaryKey(primaryKey);</span><br><span class="line">            <span class="keyword">if</span>(mqConsumerLog==<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//数据库未有记录</span></span><br><span class="line">                mqConsumerLog = <span class="keyword">new</span> TradeMqConsumerLog();</span><br><span class="line">                mqConsumerLog.setMsgTag(tags);</span><br><span class="line">                mqConsumerLog.setMsgKey(keys);</span><br><span class="line">                mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_FAIL.getCode());</span><br><span class="line">                mqConsumerLog.setMsgBody(body);</span><br><span class="line">                mqConsumerLog.setMsgId(msgId);</span><br><span class="line">                mqConsumerLog.setConsumerTimes(<span class="number">1</span>);</span><br><span class="line">                mqConsumerLogMapper.insert(mqConsumerLog);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                mqConsumerLog.setConsumerTimes(mqConsumerLog.getConsumerTimes()+<span class="number">1</span>);</span><br><span class="line">                mqConsumerLogMapper.updateByPrimaryKeySelective(mqConsumerLog);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2）回退优惠券"><a href="#2）回退优惠券" class="headerlink" title="2）回退优惠券"></a>2）回退优惠券</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"$&#123;mq.order.topic&#125;"</span>,consumerGroup = <span class="string">"$&#123;mq.order.consumer.group.name&#125;"</span>,messageModel = MessageModel.BROADCASTING )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CancelMQListener</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">MessageExt</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TradeCouponMapper couponMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 解析消息内容</span></span><br><span class="line">            String body = <span class="keyword">new</span> String(message.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">            MQEntity mqEntity = JSON.parseObject(body, MQEntity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            log.info(<span class="string">"接收到消息"</span>);</span><br><span class="line">            <span class="comment">//2. 查询优惠券信息</span></span><br><span class="line">            TradeCoupon coupon = couponMapper.selectByPrimaryKey(mqEntity.getCouponId());</span><br><span class="line">            <span class="comment">//3.更改优惠券状态</span></span><br><span class="line">            coupon.setUsedTime(<span class="keyword">null</span>);</span><br><span class="line">            coupon.setIsUsed(ShopCode.SHOP_COUPON_UNUSED.getCode());</span><br><span class="line">            coupon.setOrderId(<span class="keyword">null</span>);</span><br><span class="line">            couponMapper.updateByPrimaryKey(coupon);</span><br><span class="line">            log.info(<span class="string">"回退优惠券成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"回退优惠券失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）回退余额"><a href="#3）回退余额" class="headerlink" title="3）回退余额"></a>3）回退余额</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"$&#123;mq.order.topic&#125;"</span>,consumerGroup = <span class="string">"$&#123;mq.order.consumer.group.name&#125;"</span>,messageModel = MessageModel.BROADCASTING )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CancelMQListener</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">MessageExt</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.解析消息</span></span><br><span class="line">            String body = <span class="keyword">new</span> String(messageExt.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">            MQEntity mqEntity = JSON.parseObject(body, MQEntity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            log.info(<span class="string">"接收到消息"</span>);</span><br><span class="line">            <span class="keyword">if</span>(mqEntity.getUserMoney()!=<span class="keyword">null</span> &amp;&amp; mqEntity.getUserMoney().compareTo(BigDecimal.ZERO)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//2.调用业务层,进行余额修改</span></span><br><span class="line">                TradeUserMoneyLog userMoneyLog = <span class="keyword">new</span> TradeUserMoneyLog();</span><br><span class="line">                userMoneyLog.setUseMoney(mqEntity.getUserMoney());</span><br><span class="line">                userMoneyLog.setMoneyLogType(ShopCode.SHOP_USER_MONEY_REFUND.getCode());</span><br><span class="line">                userMoneyLog.setUserId(mqEntity.getUserId());</span><br><span class="line">                userMoneyLog.setOrderId(mqEntity.getOrderId());</span><br><span class="line">                userService.updateMoneyPaid(userMoneyLog);</span><br><span class="line">                log.info(<span class="string">"余额回退成功"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"余额回退失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4）取消订单"><a href="#4）取消订单" class="headerlink" title="4）取消订单"></a>4）取消订单</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">        String body = <span class="keyword">new</span> String(messageExt.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">        String msgId = messageExt.getMsgId();</span><br><span class="line">        String tags = messageExt.getTags();</span><br><span class="line">        String keys = messageExt.getKeys();</span><br><span class="line">        log.info(<span class="string">"CancelOrderProcessor receive message:"</span>+messageExt);</span><br><span class="line">        CancelOrderMQ cancelOrderMQ = JSON.parseObject(body, CancelOrderMQ<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        TradeOrder order = orderService.findOne(cancelOrderMQ.getOrderId());</span><br><span class="line">		order.setOrderStatus(ShopCode.SHOP_ORDER_CANCEL.getCode());</span><br><span class="line">        orderService.changeOrderStatus(order);</span><br><span class="line">        log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]状态设置为取消"</span>);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-测试"><a href="#8-3-测试" class="headerlink" title="8.3 测试"></a>8.3 测试</h2><h3 id="1）准备测试环境"><a href="#1）准备测试环境" class="headerlink" title="1）准备测试环境"></a>1）准备测试环境</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= ShopOrderServiceApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">OrderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService orderService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2）准备测试数据"><a href="#2）准备测试数据" class="headerlink" title="2）准备测试数据"></a>2）准备测试数据</h3><ul>
<li>用户数据</li>
<li>商品数据</li>
<li>优惠券数据</li>
</ul>
<h3 id="3）测试下单成功流程"><a href="#3）测试下单成功流程" class="headerlink" title="3）测试下单成功流程"></a>3）测试下单成功流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Long goodsId=XXXL;</span><br><span class="line">    Long userId=XXXL;</span><br><span class="line">    Long couponId=XXXL;</span><br><span class="line"></span><br><span class="line">    TradeOrder order = <span class="keyword">new</span> TradeOrder();</span><br><span class="line">    order.setGoodsId(goodsId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setGoodsNumber(<span class="number">1</span>);</span><br><span class="line">    order.setAddress(<span class="string">"北京"</span>);</span><br><span class="line">    order.setGoodsPrice(<span class="keyword">new</span> BigDecimal(<span class="string">"5000"</span>));</span><br><span class="line">    order.setOrderAmount(<span class="keyword">new</span> BigDecimal(<span class="string">"5000"</span>));</span><br><span class="line">    order.setMoneyPaid(<span class="keyword">new</span> BigDecimal(<span class="string">"100"</span>));</span><br><span class="line">    order.setCouponId(couponId);</span><br><span class="line">    order.setShippingFee(<span class="keyword">new</span> BigDecimal(<span class="number">0</span>));</span><br><span class="line">    orderService.confirmOrder(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行完毕后,查看数据库中用户的余额、优惠券数据，及订单的状态数据</p>
<h3 id="4）测试下单失败流程"><a href="#4）测试下单失败流程" class="headerlink" title="4）测试下单失败流程"></a>4）测试下单失败流程</h3><p>代码同上。</p>
<p>执行完毕后，查看用户的余额、优惠券数据是否发生更改，订单的状态是否为取消。</p>
<h1 id="9-支付业务"><a href="#9-支付业务" class="headerlink" title="9.支付业务"></a>9.支付业务</h1><h2 id="9-1-创建支付订单"><a href="#9-1-创建支付订单" class="headerlink" title="9.1 创建支付订单"></a>9.1 创建支付订单</h2><p><img src="https://pic.imgdb.cn/item/5f145da214195aa594e3e91e.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">createPayment</span><span class="params">(TradePay tradePay)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//查询订单支付状态</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TradePayExample payExample = <span class="keyword">new</span> TradePayExample();</span><br><span class="line">        TradePayExample.Criteria criteria = payExample.createCriteria();</span><br><span class="line">        criteria.andOrderIdEqualTo(tradePay.getOrderId());</span><br><span class="line">        criteria.andIsPaidEqualTo(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY.getCode());</span><br><span class="line">        <span class="keyword">int</span> count = tradePayMapper.countByExample(payExample);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> payId = idWorker.nextId();</span><br><span class="line">        tradePay.setPayId(payId);</span><br><span class="line">        tradePay.setIsPaid(ShopCode.SHOP_ORDER_PAY_STATUS_NO_PAY.getCode());</span><br><span class="line">        tradePayMapper.insert(tradePay);</span><br><span class="line">        log.info(<span class="string">"创建支付订单成功:"</span> + payId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_FAIL.getSuccess(), ShopCode.SHOP_FAIL.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(), ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-2-支付回调"><a href="#9-2-支付回调" class="headerlink" title="9.2 支付回调"></a>9.2 支付回调</h2><h3 id="9-2-1-流程分析"><a href="#9-2-1-流程分析" class="headerlink" title="9.2.1 流程分析"></a>9.2.1 流程分析</h3><p><img src="https://pic.imgdb.cn/item/5f145df714195aa594e4085c.jpg" alt=""></p>
<p><img src="https://pic.imgdb.cn/item/5f145e3214195aa594e419e7.jpg" alt=""></p>
<h3 id="9-2-2-代码实现"><a href="#9-2-2-代码实现" class="headerlink" title="9.2.2 代码实现"></a>9.2.2 代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">callbackPayment</span><span class="params">(TradePay tradePay)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tradePay.getIsPaid().equals(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY.getCode())) &#123;</span><br><span class="line">        tradePay = tradePayMapper.selectByPrimaryKey(tradePay.getPayId());</span><br><span class="line">        <span class="keyword">if</span> (tradePay == <span class="keyword">null</span>) &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_PAYMENT_NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        tradePay.setIsPaid(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY.getCode());</span><br><span class="line">        <span class="keyword">int</span> i = tradePayMapper.updateByPrimaryKeySelective(tradePay);</span><br><span class="line">        <span class="comment">//更新成功代表支付成功</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">            TradeMqProducerTemp mqProducerTemp = <span class="keyword">new</span> TradeMqProducerTemp();</span><br><span class="line">            mqProducerTemp.setId(String.valueOf(idWorker.nextId()));</span><br><span class="line">            mqProducerTemp.setGroupName(<span class="string">"payProducerGroup"</span>);</span><br><span class="line">            mqProducerTemp.setMsgKey(String.valueOf(tradePay.getPayId()));</span><br><span class="line">            mqProducerTemp.setMsgTag(topic);</span><br><span class="line">            mqProducerTemp.setMsgBody(JSON.toJSONString(tradePay));</span><br><span class="line">            mqProducerTemp.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">            mqProducerTempMapper.insert(mqProducerTemp);</span><br><span class="line">            TradePay finalTradePay = tradePay;</span><br><span class="line">            executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        SendResult sendResult = sendMessage(topic, </span><br><span class="line">                                                            tag, </span><br><span class="line">                                                            finalTradePay.getPayId(), </span><br><span class="line">                                                            JSON.toJSONString(finalTradePay));</span><br><span class="line">                        log.info(JSON.toJSONString(sendResult));</span><br><span class="line">                        <span class="keyword">if</span> (SendStatus.SEND_OK.equals(sendResult.getSendStatus())) &#123;</span><br><span class="line">                            mqProducerTempMapper.deleteByPrimaryKey(mqProducerTemp.getId());</span><br><span class="line">                            System.out.println(<span class="string">"删除消息表成功"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CastException.cast(ShopCode.SHOP_PAYMENT_IS_PAID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(ShopCode.SHOP_SUCCESS.getSuccess(), ShopCode.SHOP_SUCCESS.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="线程池优化消息发送逻辑"><a href="#线程池优化消息发送逻辑" class="headerlink" title="线程池优化消息发送逻辑"></a>线程池优化消息发送逻辑</h4><ul>
<li>创建线程池对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">getThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line"></span><br><span class="line">    executor.setCorePoolSize(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    executor.setMaxPoolSize(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">    executor.setThreadNamePrefix(<span class="string">"Pool-A"</span>);</span><br><span class="line"></span><br><span class="line">    executor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line"></span><br><span class="line">    executor.initialize();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用线程池</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolTaskExecutor executorService;</span><br><span class="line"></span><br><span class="line">executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SendResult sendResult = sendMessage(topic, tag, finalTradePay.getPayId(), JSON.toJSONString(finalTradePay));</span><br><span class="line">            log.info(JSON.toJSONString(sendResult));</span><br><span class="line">            <span class="keyword">if</span> (SendStatus.SEND_OK.equals(sendResult.getSendStatus())) &#123;</span><br><span class="line">                mqProducerTempMapper.deleteByPrimaryKey(mqProducerTemp.getId());</span><br><span class="line">                System.out.println(<span class="string">"删除消息表成功"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="9-2-3-处理消息"><a href="#9-2-3-处理消息" class="headerlink" title="9.2.3 处理消息"></a>9.2.3 处理消息</h3><p>支付成功后，支付服务payService发送MQ消息，订单服务、用户服务、日志服务需要订阅消息进行处理</p>
<ol>
<li>订单服务修改订单状态为已支付</li>
<li>日志服务记录支付日志</li>
<li>用户服务负责给用户增加积分</li>
</ol>
<p>以下用订单服务为例说明消息的处理情况</p>
<h4 id="1）配置RocketMQ属性值"><a href="#1）配置RocketMQ属性值" class="headerlink" title="1）配置RocketMQ属性值"></a>1）配置RocketMQ属性值</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mq.pay.topic</span>=<span class="string">payTopic</span></span><br><span class="line"><span class="meta">mq.pay.consumer.group.name</span>=<span class="string">pay_payTopic_group</span></span><br></pre></td></tr></table></figure>

<h4 id="2）消费消息"><a href="#2）消费消息" class="headerlink" title="2）消费消息"></a>2）消费消息</h4><ul>
<li>在订单服务中，配置公共的消息处理类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TradeOrder <span class="title">handleMessage</span><span class="params">(IOrderService </span></span></span><br><span class="line"><span class="function"><span class="params">                                    orderService, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    MessageExt messageExt,Integer code)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//解析消息内容</span></span><br><span class="line">        String body = <span class="keyword">new</span> String(messageExt.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">        String msgId = messageExt.getMsgId();</span><br><span class="line">        String tags = messageExt.getTags();</span><br><span class="line">        String keys = messageExt.getKeys();</span><br><span class="line">        OrderMQ orderMq = JSON.parseObject(body, OrderMQ<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//查询</span></span><br><span class="line">        TradeOrder order = orderService.findOne(orderMq.getOrderId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ShopCode.SHOP_ORDER_MESSAGE_STATUS_CANCEL.getCode().equals(code))&#123;</span><br><span class="line">            order.setOrderStatus(ShopCode.SHOP_ORDER_CANCEL.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ShopCode.SHOP_ORDER_MESSAGE_STATUS_ISPAID.getCode().equals(code))&#123;</span><br><span class="line">            order.setPayStatus(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        orderService.changeOrderStatus(order);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接受订单支付成功消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(topic = <span class="string">"$&#123;mq.pay.topic&#125;"</span>, </span><br><span class="line">                         consumerGroup = <span class="string">"$&#123;mq.pay.consumer.group.name&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayConsumer</span> <span class="keyword">extends</span> <span class="title">BaseConsumer</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">MessageExt</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">"CancelOrderProcessor receive message:"</span>+messageExt);</span><br><span class="line">            TradeOrder order = handleMessage(orderService, </span><br><span class="line">                                             messageExt, </span><br><span class="line">                                             ShopCode.SHOP_ORDER_MESSAGE_STATUS_ISPAID.getCode());</span><br><span class="line">            log.info(<span class="string">"订单:["</span>+order.getOrderId()+<span class="string">"]支付成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"订单支付失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-整体联调"><a href="#10-整体联调" class="headerlink" title="10. 整体联调"></a>10. 整体联调</h1><p>通过Rest客户端请求shop-order-web和shop-pay-web完成下单和支付操作</p>
<h2 id="10-1-准备工作"><a href="#10-1-准备工作" class="headerlink" title="10.1 准备工作"></a>10.1 准备工作</h2><h3 id="1）配置RestTemplate类"><a href="#1）配置RestTemplate类" class="headerlink" title="1）配置RestTemplate类"></a>1）配置RestTemplate类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123; RestOperations<span class="class">.<span class="keyword">class</span>, <span class="title">RestTemplate</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">RestTemplate</span> <span class="title">restTemplate</span>(<span class="title">ClientHttpRequestFactory</span> <span class="title">factory</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 utf-8 编码集的 conver 替换默认的 conver（默认的 string conver 的编码集为"ISO-8859-1"）</span></span><br><span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = restTemplate.getMessageConverters();</span><br><span class="line">        Iterator&lt;HttpMessageConverter&lt;?&gt;&gt; iterator = messageConverters.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            HttpMessageConverter&lt;?&gt; converter = iterator.next();</span><br><span class="line">            <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> StringHttpMessageConverter) &#123;</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        messageConverters.add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123;ClientHttpRequestFactory<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ClientHttpRequestFactory</span> <span class="title">simpleClientHttpRequestFactory</span>() </span>&#123;</span><br><span class="line">        SimpleClientHttpRequestFactory factory = <span class="keyword">new</span> SimpleClientHttpRequestFactory();</span><br><span class="line">        <span class="comment">// ms</span></span><br><span class="line">        factory.setReadTimeout(<span class="number">15000</span>);</span><br><span class="line">        <span class="comment">// ms</span></span><br><span class="line">        factory.setConnectTimeout(<span class="number">15000</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2）配置请求地址"><a href="#2）配置请求地址" class="headerlink" title="2）配置请求地址"></a>2）配置请求地址</h3><ul>
<li>订单系统</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.host</span>=<span class="string">http://localhost</span></span><br><span class="line"><span class="meta">server.servlet.path</span>=<span class="string">/order-web</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="meta">shop.order.baseURI</span>=<span class="string">$&#123;server.host&#125;:$&#123;server.port&#125;$&#123;server.servlet.path&#125;</span></span><br><span class="line"><span class="meta">shop.order.confirm</span>=<span class="string">/order/confirm</span></span><br></pre></td></tr></table></figure>

<ul>
<li>支付系统</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.host</span>=<span class="string">http://localhost</span></span><br><span class="line"><span class="meta">server.servlet.path</span>=<span class="string">/pay-web</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9090</span></span><br><span class="line"><span class="meta">shop.pay.baseURI</span>=<span class="string">$&#123;server.host&#125;:$&#123;server.port&#125;$&#123;server.servlet.path&#125;</span></span><br><span class="line"><span class="meta">shop.pay.createPayment</span>=<span class="string">/pay/createPayment</span></span><br><span class="line"><span class="meta">shop.pay.callbackPayment</span>=<span class="string">/pay/callbackPayment</span></span><br></pre></td></tr></table></figure>

<h2 id="10-2-下单测试"><a href="#10-2-下单测试" class="headerlink" title="10.2 下单测试"></a>10.2 下单测试</h2> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">classes</span> </span>= ShopOrderWebApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@TestPropertySource("classpath:application.properties")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;shop.order.baseURI&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String baseURI;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;shop.order.confirm&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String confirmOrderPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDWorker idWorker;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmOrder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Long goodsId=XXXL;</span><br><span class="line">        Long userId=XXXL;</span><br><span class="line">        Long couponId=XXXL;</span><br><span class="line"></span><br><span class="line">        TradeOrder order = <span class="keyword">new</span> TradeOrder();</span><br><span class="line">        order.setGoodsId(goodsId);</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setGoodsNumber(<span class="number">1</span>);</span><br><span class="line">        order.setAddress(<span class="string">"北京"</span>);</span><br><span class="line">        order.setGoodsPrice(<span class="keyword">new</span> BigDecimal(<span class="string">"5000"</span>));</span><br><span class="line">        order.setOrderAmount(<span class="keyword">new</span> BigDecimal(<span class="string">"5000"</span>));</span><br><span class="line">        order.setMoneyPaid(<span class="keyword">new</span> BigDecimal(<span class="string">"100"</span>));</span><br><span class="line">        order.setCouponId(couponId);</span><br><span class="line">        order.setShippingFee(<span class="keyword">new</span> BigDecimal(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        Result result = restTemplate.postForEntity(baseURI + confirmOrderPath, order, Result<span class="class">.<span class="keyword">class</span>).<span class="title">getBody</span>()</span>;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-3-支付测试"><a href="#10-3-支付测试" class="headerlink" title="10.3 支付测试"></a>10.3 支付测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ContextConfiguration</span>(<span class="title">classes</span> </span>= ShopPayWebApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@TestPropertySource("classpath:application.properties")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;shop.pay.baseURI&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String baseURI;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;shop.pay.createPayment&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String createPaymentPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;shop.pay.callbackPayment&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String callbackPaymentPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDWorker idWorker;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建支付订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createPayment</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Long orderId = <span class="number">346321587315814400L</span>;</span><br><span class="line">        TradePay pay = <span class="keyword">new</span> TradePay();</span><br><span class="line">        pay.setOrderId(orderId);</span><br><span class="line">        pay.setPayAmount(<span class="keyword">new</span> BigDecimal(<span class="number">4800</span>));</span><br><span class="line"></span><br><span class="line">        Result result = restTemplate.postForEntity(baseURI + createPaymentPath, pay, Result<span class="class">.<span class="keyword">class</span>).<span class="title">getBody</span>()</span>;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callbackPayment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Long payId = <span class="number">346321891507720192L</span>;</span><br><span class="line">        TradePay pay = <span class="keyword">new</span> TradePay();</span><br><span class="line">        pay.setPayId(payId);</span><br><span class="line">        pay.setIsPaid(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY.getCode());</span><br><span class="line">        Result result = restTemplate.postForEntity(baseURI + callbackPaymentPath, pay, Result<span class="class">.<span class="keyword">class</span>).<span class="title">getBody</span>()</span>;</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="11-高级功能"><a href="#11-高级功能" class="headerlink" title="11.高级功能"></a>11.高级功能</h1><h2 id="11-1消息存储"><a href="#11-1消息存储" class="headerlink" title="11.1消息存储"></a>11.1消息存储</h2><p>分布式队列因为有高可靠性，所以数据要进行持久化存储</p>
<p><img src="https://pic.imgdb.cn/item/5f10556f14195aa594b1f6fa.jpg" alt=""></p>
<ol>
<li><p>消息生产者发送消息</p>
</li>
<li><p>MQ收到消息，将消息进行持久化，在存储中新增一条记录</p>
</li>
<li><p>返回ACK给生产者</p>
</li>
<li><p>MQ push消息给对应的消费者，然后等待消费者返回ACK</p>
</li>
<li><p>如果消息消费者在指定时间内成功返回ack，那么MQ认为消息消费成功，在存储中删除消息，即执行第6步；如果MQ在指定时间内没有收到ACK，则认为消息消费失败，会尝试重新push消息,重复执行4、5、6步骤</p>
</li>
<li><p>MQ删除消息</p>
</li>
</ol>
<h3 id="11-1-1-存储介质"><a href="#11-1-1-存储介质" class="headerlink" title="11.1.1 存储介质"></a>11.1.1 存储介质</h3><ul>
<li>关系型数据库DB</li>
</ul>
<p>Apache下开源的另外一款MQ—ActiveMQ（默认采用的KahaDB做消息存储）可选用JDBC的方式来做消息持久化，通过简单的xml配置信息即可实现JDBC消息存储。由于，普通关系型数据库（如Mysql）在单表数据量达到千万级别的情况下，其IO读写性能往往会出现瓶颈。在可靠性方面，该种方案非常依赖DB，如果一旦DB出现故障，则MQ的消息就无法落盘存储会导致线上故障。</p>
<p><img src="https://pic.imgdb.cn/item/5f10575214195aa594b28e20.jpg" alt=""></p>
<ul>
<li><p>文件系统</p>
<p>目前业界较为常用的几款产品（RocketMQ/Kafka/RabbitMQ）均采用的是消息刷盘至所部署虚拟机/物理机的文件系统来做持久化（刷盘一般可以分为异步刷盘和同步刷盘两种模式）。消息刷盘为消息存储提供了一种高效率、高可靠性和高性能的数据持久化方式。除非部署MQ机器本身或是本地磁盘挂了，否则一般是不会出现无法持久化的故障问题。</p>
</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/5f10578414195aa594b29cc1.jpg" alt=""></p>
<h3 id="11-1-2-性能对比"><a href="#11-1-2-性能对比" class="headerlink" title="11.1.2 性能对比"></a>11.1.2 性能对比</h3><p>文件系统&gt;关系型数据库DB</p>
<h3 id="11-1-3-消息的存储和发送"><a href="#11-1-3-消息的存储和发送" class="headerlink" title="11.1.3 消息的存储和发送"></a>11.1.3 消息的存储和发送</h3><h4 id="1）消息存储"><a href="#1）消息存储" class="headerlink" title="1）消息存储"></a>1）消息存储</h4><p>磁盘如果使用得当，磁盘的速度完全可以匹配上网络 的数据传输速度。目前的高性能磁盘，顺序写速度可以达到600MB/s， 超过了一般网卡的传输速度。但是磁盘随机写的速度只有大概100KB/s，和顺序写的性能相差6000倍！因为有如此巨大的速度差别，好的消息队列系统会比普通的消息队列系统速度快多个数量级。RocketMQ的消息用顺序写,保证了消息存储的速度。</p>
<h4 id="2）消息发送"><a href="#2）消息发送" class="headerlink" title="2）消息发送"></a>2）消息发送</h4><p>Linux操作系统分为【用户态】和【内核态】，文件操作、网络操作需要涉及这两种形态的切换，免不了进行数据复制。</p>
<p>一台服务器 把本机磁盘文件的内容发送到客户端，一般分为两个步骤：</p>
<p>1）read；读取本地文件内容； </p>
<p>2）write；将读取的内容通过网络发送出去。</p>
<p>这两个看似简单的操作，实际进行了4 次数据复制，分别是：</p>
<ol>
<li>从磁盘复制数据到内核态内存；</li>
<li>从内核态内存复 制到用户态内存；(省去的是这一步)</li>
<li>然后从用户态 内存复制到网络驱动的内核态内存；</li>
<li>最后是从网络驱动的内核态内存复 制到网卡中进行传输。</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/5f1058a114195aa594b2eeb5.jpg" alt=""></p>
<p>RocketMQ充分利用了上述特性，也就是所谓的“零拷贝”技术，提高消息存盘和网络发送的速度。</p>
<blockquote>
<p>这里需要注意的是，采用MappedByteBuffer这种内存映射的方式有几个限制，其中之一是一次只能映射1.5~2G 的文件至用户态的虚拟内存，这也是为何RocketMQ默认设置单个CommitLog日志数据文件为1G的原因了</p>
</blockquote>
<h3 id="9-1-4-消息存储结构"><a href="#9-1-4-消息存储结构" class="headerlink" title="9.1.4 消息存储结构"></a>9.1.4 消息存储结构</h3><p>RocketMQ消息的存储是由ConsumeQueue和CommitLog配合完成 的，消息真正的物理存储文件是CommitLog，ConsumeQueue是消息的逻辑队列，类似数据库的索引文件，存储的是指向物理存储的地址。每 个Topic下的每个Message Queue都有一个对应的ConsumeQueue文件。</p>
<p><img src="https://pic.imgdb.cn/item/5f10596f14195aa594b32a01.jpg" alt=""></p>
<ul>
<li>CommitLog：存储消息的元数据</li>
<li>ConsumerQueue：存储消息在CommitLog的索引</li>
<li>IndexFile：为了消息查询提供了一种通过key或时间区间来查询消息的方法，这种通过IndexFile来查找消息的方法不影响发送与消费消息的主流程</li>
</ul>
<h3 id="9-1-5-刷盘机制"><a href="#9-1-5-刷盘机制" class="headerlink" title="9.1.5 刷盘机制"></a>9.1.5 刷盘机制</h3><p>RocketMQ的消息是存储到磁盘上的，这样既能保证断电后恢复， 又可以让存储的消息量超出内存的限制。RocketMQ为了提高性能，会尽可能地保证磁盘的顺序写。消息在通过Producer写入RocketMQ的时 候，有两种写磁盘方式，分布式同步刷盘和异步刷盘。</p>
<p><img src="https://pic.imgdb.cn/item/5f145ef914195aa594e45c89.jpg" alt=""></p>
<h4 id="1）同步刷盘"><a href="#1）同步刷盘" class="headerlink" title="1）同步刷盘"></a>1）同步刷盘</h4><p>在返回写成功状态时，消息已经被写入磁盘。具体流程是，消息写入内存的PAGECACHE后，立刻通知刷盘线程刷盘， 然后等待刷盘完成，刷盘线程执行完成后唤醒等待的线程，返回消息写 成功的状态。</p>
<h4 id="2）异步刷盘"><a href="#2）异步刷盘" class="headerlink" title="2）异步刷盘"></a>2）异步刷盘</h4><p>在返回写成功状态时，消息可能只是被写入了内存的PAGECACHE，写操作的返回快，吞吐量大；当内存里的消息量积累到一定程度时，统一触发写磁盘动作，快速写入。</p>
<h4 id="3）配置"><a href="#3）配置" class="headerlink" title="3）配置"></a>3）配置</h4><p><strong>同步刷盘还是异步刷盘，都是通过Broker配置文件里的flushDiskType 参数设置的，这个参数被配置成SYNC_FLUSH、ASYNC_FLUSH中的 一个。</strong></p>
<h2 id="11-2-高可用性机制"><a href="#11-2-高可用性机制" class="headerlink" title="11.2 高可用性机制"></a>11.2 高可用性机制</h2><p><img src="https://pic.imgdb.cn/item/5f105b5a14195aa594b3bca4.jpg" alt=""></p>
<p>RocketMQ分布式集群是通过Master和Slave的配合达到高可用性的。</p>
<p>Master和Slave的区别：在Broker的配置文件中，参数 brokerId的值为0表明这个Broker是Master，大于0表明这个Broker是 Slave，同时brokerRole参数也会说明这个Broker是Master还是Slave。</p>
<p>Master角色的Broker支持读和写，Slave角色的Broker仅支持读，也就是 Producer只能和Master角色的Broker连接写入消息；Consumer可以连接 Master角色的Broker，也可以连接Slave角色的Broker来读取消息。</p>
<h3 id="11-2-1-消息消费高可用"><a href="#11-2-1-消息消费高可用" class="headerlink" title="11.2.1 消息消费高可用"></a>11.2.1 消息消费高可用</h3><p>在Consumer的配置文件中，并不需要设置是从Master读还是从Slave 读，当Master不可用或者繁忙的时候，Consumer会被自动切换到从Slave 读。有了自动切换Consumer这种机制，当一个Master角色的机器出现故障后，Consumer仍然可以从Slave读取消息，不影响Consumer程序。这就达到了消费端的高可用性。</p>
<h3 id="11-2-2-消息发送高可用"><a href="#11-2-2-消息发送高可用" class="headerlink" title="11.2.2 消息发送高可用"></a>11.2.2 消息发送高可用</h3><p>在创建Topic的时候，把Topic的多个Message Queue创建在多个Broker组上（相同Broker名称，不同 brokerId的机器组成一个Broker组），这样当一个Broker组的Master不可 用后，其他组的Master仍然可用，Producer仍然可以发送消息。 RocketMQ目前还不支持把Slave自动转成Master，如果机器资源不足， 需要把Slave转成Master，则要手动停止Slave角色的Broker，更改配置文 件，用新的配置文件启动Broker。</p>
<h3 id="11-2-3-消息主从复制"><a href="#11-2-3-消息主从复制" class="headerlink" title="11.2.3 消息主从复制"></a>11.2.3 消息主从复制</h3><p>如果一个Broker组有Master和Slave，消息需要从Master复制到Slave 上，有同步和异步两种复制方式。</p>
<h4 id="1）同步复制"><a href="#1）同步复制" class="headerlink" title="1）同步复制"></a>1）同步复制</h4><p>同步复制方式是等Master和Slave均写 成功后才反馈给客户端写成功状态；</p>
<p>在同步复制方式下，如果Master出故障， Slave上有全部的备份数据，容易恢复，但是同步复制会增大数据写入 延迟，降低系统吞吐量。</p>
<h4 id="2）异步复制"><a href="#2）异步复制" class="headerlink" title="2）异步复制"></a>2）异步复制</h4><p>异步复制方式是只要Master写成功 即可反馈给客户端写成功状态。</p>
<p>在异步复制方式下，系统拥有较低的延迟和较高的吞吐量，但是如果Master出了故障，有些数据因为没有被写 入Slave，有可能会丢失；</p>
<h4 id="3）配置-1"><a href="#3）配置-1" class="headerlink" title="3）配置"></a>3）配置</h4><p>同步复制和异步复制是通过Broker配置文件里的brokerRole参数进行设置的，这个参数可以被设置成ASYNC_MASTER、 SYNC_MASTER、SLAVE三个值中的一个。</p>
<h4 id="4）总结"><a href="#4）总结" class="headerlink" title="4）总结"></a>4）总结</h4><p><img src="https://pic.imgdb.cn/item/5f105de114195aa594b477c7.jpg" alt=""></p>
<p>实际应用中要结合业务场景，合理设置刷盘方式和主从复制方式， 尤其是SYNC_FLUSH方式，由于频繁地触发磁盘写动作，会明显降低 性能。通常情况下，应该把Master和Save配置成ASYNC_FLUSH的刷盘 方式，主从之间配置成SYNC_MASTER的复制方式，这样即使有一台 机器出故障，仍然能保证数据不丢，是个不错的选择。</p>
<h2 id="11-3-负载均衡"><a href="#11-3-负载均衡" class="headerlink" title="11.3 负载均衡"></a>11.3 负载均衡</h2><h3 id="11-3-1-Producer负载均衡"><a href="#11-3-1-Producer负载均衡" class="headerlink" title="11.3.1 Producer负载均衡"></a>11.3.1 Producer负载均衡</h3><p>Producer端，每个实例在发消息的时候，默认会轮询所有的message queue发送，以达到让消息平均落在不同的queue上。而由于queue可以散落在不同的broker，所以消息就发送到不同的broker下，如下图：</p>
<p><img src="https://pic.imgdb.cn/item/5f105e2214195aa594b48cca.jpg" alt=""></p>
<p>图中箭头线条上的标号代表顺序，发布方会把第一条消息发送至 Queue 0，然后第二条消息发送至 Queue 1，以此类推。</p>
<h3 id="11-3-2-Consumer负载均衡"><a href="#11-3-2-Consumer负载均衡" class="headerlink" title="11.3.2 Consumer负载均衡"></a>11.3.2 Consumer负载均衡</h3><h4 id="1）集群模式"><a href="#1）集群模式" class="headerlink" title="1）集群模式"></a>1）集群模式</h4><p>在集群消费模式下，每条消息只需要投递到订阅这个topic的Consumer Group下的一个实例即可。RocketMQ采用主动拉取的方式拉取并消费消息，在拉取的时候需要明确指定拉取哪一条message queue。</p>
<p>而每当实例的数量有变更，都会触发一次所有实例的负载均衡，这时候会按照queue的数量和实例的数量平均分配queue给每个实例。</p>
<p>默认的分配算法是AllocateMessageQueueAveragely，如下图：</p>
<p><img src="https://pic.imgdb.cn/item/5f105e7d14195aa594b4aa8b.jpg" alt=""></p>
<p>还有另外一种平均的算法是AllocateMessageQueueAveragelyByCircle，也是平均分摊每一条queue，只是以环状轮流分queue的形式，如下图：</p>
<p><img src="https://pic.imgdb.cn/item/5f105ec514195aa594b4bfa4.jpg" alt=""></p>
<p>需要注意的是，集群模式下，queue都是只允许分配只一个实例，这是由于如果多个实例同时消费一个queue的消息，由于拉取哪些消息是consumer主动控制的，那样会导致同一个消息在不同的实例下被消费多次，所以算法上都是一个queue只分给一个consumer实例，一个consumer实例可以允许同时分到不同的queue。</p>
<p>通过增加consumer实例去分摊queue的消费，可以起到水平扩展的消费能力的作用。而有实例下线的时候，会重新触发负载均衡，这时候原来分配到的queue将分配到其他实例上继续消费。</p>
<p>但是如果consumer实例的数量比message queue的总数量还多的话，多出来的consumer实例将无法分到queue，也就无法消费到消息，也就无法起到分摊负载的作用了。所以需要控制让queue的总数量大于等于consumer的数量。</p>
<h4 id="2）广播模式-1"><a href="#2）广播模式-1" class="headerlink" title="2）广播模式"></a>2）广播模式</h4><p>由于广播模式下要求一条消息需要投递到一个消费组下面所有的消费者实例，所以也就没有消息被分摊消费的说法。</p>
<p>在实现上，其中一个不同就是在consumer分配queue的时候，所有consumer都分到所有的queue。</p>
<p><img src="https://pic.imgdb.cn/item/5f145f0f14195aa594e461fe.jpg" alt=""></p>
<h2 id="11-4-消息重试"><a href="#11-4-消息重试" class="headerlink" title="11.4 消息重试"></a>11.4 消息重试</h2><h3 id="11-4-1-顺序消息的重试"><a href="#11-4-1-顺序消息的重试" class="headerlink" title="11.4.1 顺序消息的重试"></a>11.4.1 顺序消息的重试</h3><p>对于顺序消息，当消费者消费消息失败后，消息队列 RocketMQ 会自动不断进行消息重试（每次间隔时间为 1 秒），这时，应用会出现消息消费被阻塞的情况。因此，在使用顺序消息时，务必保证应用能够及时监控并处理消费失败的情况，避免阻塞现象的发生。</p>
<h3 id="11-4-2-无序消息的重试"><a href="#11-4-2-无序消息的重试" class="headerlink" title="11.4.2 无序消息的重试"></a>11.4.2 无序消息的重试</h3><p>对于无序消息（普通、定时、延时、事务消息），当消费者消费消息失败时，您可以通过设置返回状态达到消息重试的结果。</p>
<p>无序消息的重试只针对集群消费方式生效；广播方式不提供失败重试特性，即消费失败后，失败消息不再重试，继续消费新的消息。</p>
<h4 id="1）重试次数"><a href="#1）重试次数" class="headerlink" title="1）重试次数"></a>1）重试次数</h4><p>消息队列 RocketMQ 默认允许每条消息最多重试 16 次，每次重试的间隔时间如下：</p>
<table>
<thead>
<tr>
<th align="center">第几次重试</th>
<th align="center">与上次重试的间隔时间</th>
<th align="center">第几次重试</th>
<th align="center">与上次重试的间隔时间</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">10 秒</td>
<td align="center">9</td>
<td align="center">7 分钟</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">30 秒</td>
<td align="center">10</td>
<td align="center">8 分钟</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">1 分钟</td>
<td align="center">11</td>
<td align="center">9 分钟</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">2 分钟</td>
<td align="center">12</td>
<td align="center">10 分钟</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">3 分钟</td>
<td align="center">13</td>
<td align="center">20 分钟</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">4 分钟</td>
<td align="center">14</td>
<td align="center">30 分钟</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">5 分钟</td>
<td align="center">15</td>
<td align="center">1 小时</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">6 分钟</td>
<td align="center">16</td>
<td align="center">2 小时</td>
</tr>
</tbody></table>
<p>如果消息重试 16 次后仍然失败，消息将不再投递。如果严格按照上述重试时间间隔计算，某条消息在一直消费失败的前提下，将会在接下来的 4 小时 46 分钟之内进行 16 次重试，超过这个时间范围消息将不再重试投递。</p>
<p><strong>注意：</strong> 一条消息无论重试多少次，这些重试消息的 Message ID 不会改变。</p>
<h4 id="2）配置方式"><a href="#2）配置方式" class="headerlink" title="2）配置方式"></a>2）配置方式</h4><p><strong>消费失败后，重试配置方式</strong></p>
<p>集群消费方式下，消息消费失败后期望消息重试，需要在消息监听器接口的实现中明确进行配置（三种方式任选一种）：</p>
<ul>
<li>返回 Action.ReconsumeLater （推荐）</li>
<li>返回 Null</li>
<li>抛出异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//处理消息</span></span><br><span class="line">        doConsumeMessage(message);</span><br><span class="line">        <span class="comment">//方式1：返回 Action.ReconsumeLater，消息将重试</span></span><br><span class="line">        <span class="keyword">return</span> Action.ReconsumeLater;</span><br><span class="line">        <span class="comment">//方式2：返回 null，消息将重试</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//方式3：直接抛出异常， 消息将重试</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Consumer Message exceotion"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费失败后，不重试配置方式</strong></p>
<p>集群消费方式下，消息失败后期望消息不重试，需要捕获消费逻辑中可能抛出的异常，最终返回 Action.CommitMessage，此后这条消息将不会再重试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doConsumeMessage(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">//捕获消费逻辑中的所有异常，并返回 Action.CommitMessage;</span></span><br><span class="line">            <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//消息处理正常，直接返回 Action.CommitMessage;</span></span><br><span class="line">        <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>自定义消息最大重试次数</strong></p>
<p>消息队列 RocketMQ 允许 Consumer 启动的时候设置最大重试次数，重试时间间隔将按照如下策略：</p>
<ul>
<li>最大重试次数小于等于 16 次，则重试时间间隔同上表描述。</li>
<li>最大重试次数大于 16 次，超过 16 次的重试时间间隔均为每次 2 小时。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line"><span class="comment">//配置对应 Group ID 的最大消息重试次数为 20 次</span></span><br><span class="line">properties.put(PropertyKeyConst.MaxReconsumeTimes,<span class="string">"20"</span>);</span><br><span class="line">Consumer consumer =ONSFactory.createConsumer(properties);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<ul>
<li>消息最大重试次数的设置对相同 Group ID 下的所有 Consumer 实例有效。</li>
<li>如果只对相同 Group ID 下两个 Consumer 实例中的其中一个设置了 MaxReconsumeTimes，那么该配置对两个 Consumer 实例均生效。</li>
<li>配置采用覆盖的方式生效，即最后启动的 Consumer 实例会覆盖之前的启动实例的配置</li>
</ul>
</blockquote>
<p><strong>获取消息重试次数</strong></p>
<p>消费者收到消息后，可按照如下方式获取消息的重试次数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListenerImpl</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取消息的重试次数</span></span><br><span class="line">        System.out.println(message.getReconsumeTimes());</span><br><span class="line">        <span class="keyword">return</span> Action.CommitMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-5-死信队列"><a href="#11-5-死信队列" class="headerlink" title="11.5 死信队列"></a>11.5 死信队列</h2><p>当一条消息初次消费失败，消息队列 RocketMQ 会自动进行消息重试；达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息，此时，消息队列 RocketMQ 不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。</p>
<p>在消息队列 RocketMQ 中，这种正常情况下无法被消费的消息称为死信消息（Dead-Letter Message），存储死信消息的特殊队列称为死信队列（Dead-Letter Queue）。</p>
<h3 id="11-5-1-死信特性"><a href="#11-5-1-死信特性" class="headerlink" title="11.5.1 死信特性"></a>11.5.1 死信特性</h3><p>死信消息具有以下特性</p>
<ul>
<li>不会再被消费者正常消费。</li>
<li>有效期与正常消息相同，均为 3 天，3 天后会被自动删除。因此，请在死信消息产生后的 3 天内及时处理。</li>
</ul>
<p>死信队列具有以下特性：</p>
<ul>
<li>一个死信队列对应一个 Group ID， 而不是对应单个消费者实例。</li>
<li>如果一个 Group ID 未产生死信消息，消息队列 RocketMQ 不会为其创建相应的死信队列。</li>
<li>一个死信队列包含了对应 Group ID 产生的所有死信消息，不论该消息属于哪个 Topic。</li>
</ul>
<h3 id="11-5-2-查看死信信息"><a href="#11-5-2-查看死信信息" class="headerlink" title="11.5.2 查看死信信息"></a>11.5.2 查看死信信息</h3><ol>
<li>在控制台查询出现死信队列的主题信息</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/5f10608f14195aa594b54889.jpg" alt=""></p>
<ol start="2">
<li>在消息界面根据主题查询死信消息</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/5f145f2c14195aa594e4694c.jpg" alt=""></p>
<ol start="3">
<li>选择重新发送消息</li>
</ol>
<p>一条消息进入死信队列，意味着某些因素导致消费者无法正常消费该消息，因此，通常需要您对其进行特殊处理。排查可疑因素并解决问题后，可以在消息队列 RocketMQ 控制台重新发送该消息，让消费者重新消费一次。</p>
<h2 id="11-6-消费幂等"><a href="#11-6-消费幂等" class="headerlink" title="11.6 消费幂等"></a>11.6 消费幂等</h2><p>消息队列 RocketMQ 消费者在接收到消息以后，有必要根据业务上的唯一 Key 对消息做幂等处理的必要性。</p>
<h3 id="11-6-1-消费幂等的必要性"><a href="#11-6-1-消费幂等的必要性" class="headerlink" title="11.6.1 消费幂等的必要性"></a>11.6.1 消费幂等的必要性</h3><p>在互联网应用中，尤其在网络不稳定的情况下，消息队列 RocketMQ 的消息有可能会出现重复，这个重复简单可以概括为以下情况：</p>
<ul>
<li><p>发送时消息重复</p>
<p>当一条消息已被成功发送到服务端并完成持久化，此时出现了网络闪断或者客户端宕机，导致服务端对客户端应答失败。 如果此时生产者意识到消息发送失败并尝试再次发送消息，消费者后续会收到两条内容相同并且 Message ID 也相同的消息。</p>
</li>
<li><p>投递时消息重复</p>
<p>消息消费的场景下，消息已投递到消费者并完成业务处理，当客户端给服务端反馈应答的时候网络闪断。 为了保证消息至少被消费一次，消息队列 RocketMQ 的服务端将在网络恢复后再次尝试投递之前已被处理过的消息，消费者后续会收到两条内容相同并且 Message ID 也相同的消息。</p>
</li>
<li><p>负载均衡时消息重复（包括但不限于网络抖动、Broker 重启以及订阅方应用重启）</p>
<p>当消息队列 RocketMQ 的 Broker 或客户端重启、扩容或缩容时，会触发 Rebalance，此时消费者可能会收到重复消息。</p>
</li>
</ul>
<h3 id="11-6-2-处理方式"><a href="#11-6-2-处理方式" class="headerlink" title="11.6.2 处理方式"></a>11.6.2 处理方式</h3><p>因为 Message ID 有可能出现冲突（重复）的情况，所以真正安全的幂等处理，不建议以 Message ID 作为处理依据。 最好的方式是以业务唯一标识作为幂等处理的关键依据，而业务的唯一标识可以通过消息 Key 进行设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Message message = <span class="keyword">new</span> Message();</span><br><span class="line">message.setKey(<span class="string">"ORDERID_100"</span>);</span><br><span class="line">SendResult sendResult = producer.send(message);</span><br></pre></td></tr></table></figure>

<p>订阅方收到消息时可以根据消息的 Key 进行幂等处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">consumer.subscribe(<span class="string">"ons_test"</span>, <span class="string">"*"</span>, <span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">consume</span><span class="params">(Message message, ConsumeContext context)</span> </span>&#123;</span><br><span class="line">        String key = message.getKey()</span><br><span class="line">        <span class="comment">// 根据业务唯一标识的 key 做幂等处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MQ/" rel="tag"># MQ</a>
          
            <a href="/tags/RocketMq/" rel="tag"># RocketMq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/30/%E7%BA%BF%E7%A8%8B%E5%85%AB%E5%A4%A7%E6%A0%B8%E5%BF%83-Java%E5%B9%B6%E5%8F%91%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E7%B2%BE%E8%AE%B2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="线程八大核心+Java并发底层原理精讲学习笔记">
                <i class="fa fa-chevron-left"></i> 线程八大核心+Java并发底层原理精讲学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/10/redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="prev" title="redis源码阅读">
                redis源码阅读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/timg.jpg"
                alt="宋梓立 sorie" />
            
              <p class="site-author-name" itemprop="name">宋梓立 sorie</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Ewasong" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:819294006@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MQ介绍"><span class="nav-number">1.</span> <span class="nav-text">MQ介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-MQ的优点和缺点"><span class="nav-number">1.1.</span> <span class="nav-text">1.2 MQ的优点和缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-MQ产品比较"><span class="nav-number">1.2.</span> <span class="nav-text">1.3 MQ产品比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RocketMq快速入门"><span class="nav-number">2.</span> <span class="nav-text">RocketMq快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1准备工作"><span class="nav-number">2.1.</span> <span class="nav-text">2.1准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载RocketMq"><span class="nav-number">2.1.1.</span> <span class="nav-text">下载RocketMq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统环境"><span class="nav-number">2.1.2.</span> <span class="nav-text">系统环境</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-安装RocketMQ"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 安装RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装步骤"><span class="nav-number">2.2.1.</span> <span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录介绍"><span class="nav-number">2.2.2.</span> <span class="nav-text">目录介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3启动RocketMQ"><span class="nav-number">2.3.</span> <span class="nav-text">2.3启动RocketMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4测试RocketMQ"><span class="nav-number">2.4.</span> <span class="nav-text">2.4测试RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发送"><span class="nav-number">2.4.1.</span> <span class="nav-text">消息发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接受消息"><span class="nav-number">2.4.2.</span> <span class="nav-text">接受消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-关闭RocketMQ"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 关闭RocketMQ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RocketMQ集群搭建"><span class="nav-number">3.</span> <span class="nav-text">RocketMQ集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1各角色介绍"><span class="nav-number">3.1.</span> <span class="nav-text">3.1各角色介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-集群搭建方式"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 集群搭建方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群特点"><span class="nav-number">3.2.1.</span> <span class="nav-text">集群特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群模式"><span class="nav-number">3.2.2.</span> <span class="nav-text">集群模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-双主双从集群搭建"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 双主双从集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总体架构"><span class="nav-number">3.3.1.</span> <span class="nav-text">总体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群工作流程"><span class="nav-number">3.3.2.</span> <span class="nav-text">集群工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器环境"><span class="nav-number">3.3.3.</span> <span class="nav-text">服务器环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Host添加信息"><span class="nav-number">3.3.4.</span> <span class="nav-text">Host添加信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防火墙配置"><span class="nav-number">3.3.5.</span> <span class="nav-text">防火墙配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量配置"><span class="nav-number">3.3.6.</span> <span class="nav-text">环境变量配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消息存储路径"><span class="nav-number">3.3.7.</span> <span class="nav-text">创建消息存储路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#broker配置文件"><span class="nav-number">3.3.8.</span> <span class="nav-text">broker配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改启动脚本文件"><span class="nav-number">3.3.9.</span> <span class="nav-text">修改启动脚本文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务启动"><span class="nav-number">3.3.10.</span> <span class="nav-text">服务启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看日志"><span class="nav-number">3.3.11.</span> <span class="nav-text">查看日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-mqadmin-管理工具"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 mqadmin 管理工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方式"><span class="nav-number">3.4.1.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令介绍"><span class="nav-number">3.4.2.</span> <span class="nav-text">命令介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-集群监控平台搭建"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.5 集群监控平台搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">3.4.4.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-2-下载并编译打包"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">3.5.2 下载并编译打包</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#消息发送样例"><span class="nav-number">4.</span> <span class="nav-text">消息发送样例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-基本样例"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 基本样例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-消息发送"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 消息发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）发送同步消息"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">1）发送同步消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-发送异步消息"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">2)  发送异步消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-单向消息"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">3) 单向消息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-消费消息"><span class="nav-number">4.1.2.</span> <span class="nav-text">4.1.2 消费消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）-负载均衡模式"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">1） 负载均衡模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）广播模式"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">2）广播模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-顺序消息"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 顺序消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-顺序消息生产"><span class="nav-number">4.2.1.</span> <span class="nav-text">4.2.1 顺序消息生产</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-顺序消息消费"><span class="nav-number">4.2.2.</span> <span class="nav-text">4.2.2 顺序消息消费</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-延时消息"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 延时消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-启动消息消费者"><span class="nav-number">4.3.1.</span> <span class="nav-text">4.3.1 启动消息消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-发送延时消息"><span class="nav-number">4.3.2.</span> <span class="nav-text">4.3.2 发送延时消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-验证"><span class="nav-number">4.3.3.</span> <span class="nav-text">4.3.3 验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-4-使用限制"><span class="nav-number">4.3.4.</span> <span class="nav-text">4.3.4 使用限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-批量消息"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 批量消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-发送批量消息"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.4.1 发送批量消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-过滤消息"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 过滤消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-1-SQL基本语法"><span class="nav-number">4.5.1.</span> <span class="nav-text">4.5.1 SQL基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-2-消息生产者"><span class="nav-number">4.5.2.</span> <span class="nav-text">4.5.2 消息生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-3-消息消费者"><span class="nav-number">4.5.3.</span> <span class="nav-text">4.5.3 消息消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-事务消息"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 事务消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-1-流程分析"><span class="nav-number">4.6.1.</span> <span class="nav-text">4.6.1  流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）事务消息发送及提交"><span class="nav-number">4.6.1.1.</span> <span class="nav-text">1）事务消息发送及提交</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）消息补偿"><span class="nav-number">4.6.1.2.</span> <span class="nav-text">2）消息补偿</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）事务消息状态"><span class="nav-number">4.6.1.3.</span> <span class="nav-text">3）事务消息状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-2-发送事务消息"><span class="nav-number">4.6.2.</span> <span class="nav-text">4.6.2 发送事务消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-创建事务性生产者"><span class="nav-number">4.6.2.1.</span> <span class="nav-text">1) 创建事务性生产者</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-3-使用限制"><span class="nav-number">4.6.3.</span> <span class="nav-text">4.6.3 使用限制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#案例介绍"><span class="nav-number">5.</span> <span class="nav-text">案例介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-业务分析"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 业务分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）下单"><span class="nav-number">5.1.1.</span> <span class="nav-text">1）下单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）支付"><span class="nav-number">5.1.2.</span> <span class="nav-text">2）支付</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-问题分析"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题1"><span class="nav-number">5.2.1.</span> <span class="nav-text">问题1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题2"><span class="nav-number">5.2.2.</span> <span class="nav-text">问题2</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#技术分析"><span class="nav-number">6.</span> <span class="nav-text">技术分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-技术选型"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 技术选型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-SpringBoot整合RocketMQ"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 SpringBoot整合RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-消息生产者"><span class="nav-number">6.2.1.</span> <span class="nav-text">6.2.1 消息生产者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-添加依赖"><span class="nav-number">6.2.1.1.</span> <span class="nav-text">1) 添加依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-发送消息测试者"><span class="nav-number">6.2.1.2.</span> <span class="nav-text">2) 发送消息测试者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）application-properties"><span class="nav-number">6.2.1.3.</span> <span class="nav-text">3）application.properties</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2-消息消费者"><span class="nav-number">6.2.2.</span> <span class="nav-text">6.2.2 消息消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-添加依赖-1"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">1) 添加依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-消费者"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">2) 消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）application-properties-1"><span class="nav-number">6.2.2.3.</span> <span class="nav-text">3）application.properties</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-Spring-Boot整合Dubbo"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 Spring Boot整合Dubbo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-搭建Zookeeper集群"><span class="nav-number">6.3.1.</span> <span class="nav-text">6.3.1 搭建Zookeeper集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）准备工作"><span class="nav-number">6.3.1.1.</span> <span class="nav-text">1）准备工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-配置集群"><span class="nav-number">6.3.1.2.</span> <span class="nav-text">2) 配置集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-启动集群"><span class="nav-number">6.3.1.3.</span> <span class="nav-text">3) 启动集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-RPC服务接口"><span class="nav-number">6.3.2.</span> <span class="nav-text">6.3.2 RPC服务接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-3-服务提供者"><span class="nav-number">6.3.3.</span> <span class="nav-text">6.2.3 服务提供者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）依赖"><span class="nav-number">6.3.3.1.</span> <span class="nav-text">1）依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）application-properties"><span class="nav-number">6.3.3.2.</span> <span class="nav-text">2）application.properties</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-启动类"><span class="nav-number">6.3.3.3.</span> <span class="nav-text">3)启动类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-服务实现"><span class="nav-number">6.3.3.4.</span> <span class="nav-text">4)服务实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-4-dubbo-admin搭建"><span class="nav-number">6.3.4.</span> <span class="nav-text">6.2.4 dubbo-admin搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-4-服务消费者"><span class="nav-number">6.3.5.</span> <span class="nav-text">6.2.4 服务消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）-添加依赖"><span class="nav-number">6.3.5.1.</span> <span class="nav-text">1） 添加依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）配置文件"><span class="nav-number">6.3.5.2.</span> <span class="nav-text">2）配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）启动类"><span class="nav-number">6.3.5.3.</span> <span class="nav-text">3）启动类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4）Controller"><span class="nav-number">6.3.5.4.</span> <span class="nav-text">4）Controller</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-环境搭建"><span class="nav-number">6.3.6.</span> <span class="nav-text">7. 环境搭建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-数据库"><span class="nav-number">6.4.</span> <span class="nav-text">7.1 数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）优惠券表"><span class="nav-number">6.4.1.</span> <span class="nav-text">1）优惠券表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）商品表"><span class="nav-number">6.4.2.</span> <span class="nav-text">2）商品表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）订单表"><span class="nav-number">6.4.3.</span> <span class="nav-text">3）订单表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）订单商品日志表"><span class="nav-number">6.4.4.</span> <span class="nav-text">4）订单商品日志表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5）用户表"><span class="nav-number">6.4.5.</span> <span class="nav-text">5）用户表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6）用户余额日志表"><span class="nav-number">6.4.6.</span> <span class="nav-text">6）用户余额日志表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7）订单支付表"><span class="nav-number">6.4.7.</span> <span class="nav-text">7）订单支付表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8）MQ消息生产表"><span class="nav-number">6.4.8.</span> <span class="nav-text">8）MQ消息生产表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9）MQ消息消费表"><span class="nav-number">6.4.9.</span> <span class="nav-text">9）MQ消息消费表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-项目初始化"><span class="nav-number">6.5.</span> <span class="nav-text">7.2 项目初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-工程概览"><span class="nav-number">6.5.1.</span> <span class="nav-text">7.2.1 工程概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-工程关系"><span class="nav-number">6.5.2.</span> <span class="nav-text">7.2.2 工程关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-Mybatis逆向工程使用"><span class="nav-number">6.6.</span> <span class="nav-text">7.3 Mybatis逆向工程使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-公共类介绍"><span class="nav-number">6.7.</span> <span class="nav-text">7.4 公共类介绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8下单业务"><span class="nav-number">7.</span> <span class="nav-text">8下单业务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-下单基本流程"><span class="nav-number">7.1.</span> <span class="nav-text">8.1 下单基本流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）接口定义"><span class="nav-number">7.1.1.</span> <span class="nav-text">1）接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）业务类实现"><span class="nav-number">7.1.2.</span> <span class="nav-text">2）业务类实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）校验订单"><span class="nav-number">7.1.3.</span> <span class="nav-text">3）校验订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）生成预订单"><span class="nav-number">7.1.4.</span> <span class="nav-text">4）生成预订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5）扣减库存"><span class="nav-number">7.1.5.</span> <span class="nav-text">5）扣减库存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6）扣减优惠券"><span class="nav-number">7.1.6.</span> <span class="nav-text">6）扣减优惠券</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7）扣减用户余额"><span class="nav-number">7.1.7.</span> <span class="nav-text">7）扣减用户余额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8）确认订单"><span class="nav-number">7.1.8.</span> <span class="nav-text">8）确认订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9）小结"><span class="nav-number">7.1.9.</span> <span class="nav-text">9）小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-失败补偿机制"><span class="nav-number">7.2.</span> <span class="nav-text">8.2 失败补偿机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-消息发送方"><span class="nav-number">7.2.1.</span> <span class="nav-text">8.2.1 消息发送方</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-消费接收方"><span class="nav-number">7.2.2.</span> <span class="nav-text">8.2.2 消费接收方</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）回退库存"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">1）回退库存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）回退优惠券"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">2）回退优惠券</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）回退余额"><span class="nav-number">7.2.2.3.</span> <span class="nav-text">3）回退余额</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4）取消订单"><span class="nav-number">7.2.2.4.</span> <span class="nav-text">4）取消订单</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-测试"><span class="nav-number">7.3.</span> <span class="nav-text">8.3 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）准备测试环境"><span class="nav-number">7.3.1.</span> <span class="nav-text">1）准备测试环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）准备测试数据"><span class="nav-number">7.3.2.</span> <span class="nav-text">2）准备测试数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）测试下单成功流程"><span class="nav-number">7.3.3.</span> <span class="nav-text">3）测试下单成功流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）测试下单失败流程"><span class="nav-number">7.3.4.</span> <span class="nav-text">4）测试下单失败流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-支付业务"><span class="nav-number">8.</span> <span class="nav-text">9.支付业务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-创建支付订单"><span class="nav-number">8.1.</span> <span class="nav-text">9.1 创建支付订单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-支付回调"><span class="nav-number">8.2.</span> <span class="nav-text">9.2 支付回调</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-流程分析"><span class="nav-number">8.2.1.</span> <span class="nav-text">9.2.1 流程分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-代码实现"><span class="nav-number">8.2.2.</span> <span class="nav-text">9.2.2 代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#线程池优化消息发送逻辑"><span class="nav-number">8.2.2.1.</span> <span class="nav-text">线程池优化消息发送逻辑</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-3-处理消息"><span class="nav-number">8.2.3.</span> <span class="nav-text">9.2.3 处理消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）配置RocketMQ属性值"><span class="nav-number">8.2.3.1.</span> <span class="nav-text">1）配置RocketMQ属性值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）消费消息"><span class="nav-number">8.2.3.2.</span> <span class="nav-text">2）消费消息</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-整体联调"><span class="nav-number">9.</span> <span class="nav-text">10. 整体联调</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-准备工作"><span class="nav-number">9.1.</span> <span class="nav-text">10.1 准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）配置RestTemplate类"><span class="nav-number">9.1.1.</span> <span class="nav-text">1）配置RestTemplate类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）配置请求地址"><span class="nav-number">9.1.2.</span> <span class="nav-text">2）配置请求地址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-下单测试"><span class="nav-number">9.2.</span> <span class="nav-text">10.2 下单测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-支付测试"><span class="nav-number">9.3.</span> <span class="nav-text">10.3 支付测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-高级功能"><span class="nav-number">10.</span> <span class="nav-text">11.高级功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1消息存储"><span class="nav-number">10.1.</span> <span class="nav-text">11.1消息存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-1-存储介质"><span class="nav-number">10.1.1.</span> <span class="nav-text">11.1.1 存储介质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-2-性能对比"><span class="nav-number">10.1.2.</span> <span class="nav-text">11.1.2 性能对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-3-消息的存储和发送"><span class="nav-number">10.1.3.</span> <span class="nav-text">11.1.3 消息的存储和发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）消息存储"><span class="nav-number">10.1.3.1.</span> <span class="nav-text">1）消息存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）消息发送"><span class="nav-number">10.1.3.2.</span> <span class="nav-text">2）消息发送</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4-消息存储结构"><span class="nav-number">10.1.4.</span> <span class="nav-text">9.1.4 消息存储结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-5-刷盘机制"><span class="nav-number">10.1.5.</span> <span class="nav-text">9.1.5 刷盘机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）同步刷盘"><span class="nav-number">10.1.5.1.</span> <span class="nav-text">1）同步刷盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）异步刷盘"><span class="nav-number">10.1.5.2.</span> <span class="nav-text">2）异步刷盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）配置"><span class="nav-number">10.1.5.3.</span> <span class="nav-text">3）配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-高可用性机制"><span class="nav-number">10.2.</span> <span class="nav-text">11.2 高可用性机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-1-消息消费高可用"><span class="nav-number">10.2.1.</span> <span class="nav-text">11.2.1 消息消费高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-2-消息发送高可用"><span class="nav-number">10.2.2.</span> <span class="nav-text">11.2.2 消息发送高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-3-消息主从复制"><span class="nav-number">10.2.3.</span> <span class="nav-text">11.2.3 消息主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）同步复制"><span class="nav-number">10.2.3.1.</span> <span class="nav-text">1）同步复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）异步复制"><span class="nav-number">10.2.3.2.</span> <span class="nav-text">2）异步复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）配置-1"><span class="nav-number">10.2.3.3.</span> <span class="nav-text">3）配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4）总结"><span class="nav-number">10.2.3.4.</span> <span class="nav-text">4）总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-负载均衡"><span class="nav-number">10.3.</span> <span class="nav-text">11.3 负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-1-Producer负载均衡"><span class="nav-number">10.3.1.</span> <span class="nav-text">11.3.1 Producer负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-2-Consumer负载均衡"><span class="nav-number">10.3.2.</span> <span class="nav-text">11.3.2 Consumer负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）集群模式"><span class="nav-number">10.3.2.1.</span> <span class="nav-text">1）集群模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）广播模式-1"><span class="nav-number">10.3.2.2.</span> <span class="nav-text">2）广播模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-消息重试"><span class="nav-number">10.4.</span> <span class="nav-text">11.4 消息重试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-1-顺序消息的重试"><span class="nav-number">10.4.1.</span> <span class="nav-text">11.4.1 顺序消息的重试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-2-无序消息的重试"><span class="nav-number">10.4.2.</span> <span class="nav-text">11.4.2 无序消息的重试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）重试次数"><span class="nav-number">10.4.2.1.</span> <span class="nav-text">1）重试次数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）配置方式"><span class="nav-number">10.4.2.2.</span> <span class="nav-text">2）配置方式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-5-死信队列"><span class="nav-number">10.5.</span> <span class="nav-text">11.5 死信队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-1-死信特性"><span class="nav-number">10.5.1.</span> <span class="nav-text">11.5.1 死信特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-2-查看死信信息"><span class="nav-number">10.5.2.</span> <span class="nav-text">11.5.2 查看死信信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-6-消费幂等"><span class="nav-number">10.6.</span> <span class="nav-text">11.6 消费幂等</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-6-1-消费幂等的必要性"><span class="nav-number">10.6.1.</span> <span class="nav-text">11.6.1 消费幂等的必要性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-6-2-处理方式"><span class="nav-number">10.6.2.</span> <span class="nav-text">11.6.2 处理方式</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宋梓立 sorie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  









  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'XTY8e76465N8ugbyhpCoS88f-gzGzoHsz',
        appKey: 'dwWTNcurePtzzBdMO62hSRMy',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
